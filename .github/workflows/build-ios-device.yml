# ã“ã®ãƒ¬ã‚·ãƒ”ã®åå‰ï¼šiPhoneå®Ÿæ©Ÿç”¨ãƒ“ãƒ«ãƒ‰
name: Build iOS (Device)

# ã„ã¤å‹•ãã‹ï¼šæ‰‹å‹•ã§ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã¨ã
on:
  workflow_dispatch:

# ãŠä»•äº‹ã®å†…å®¹
jobs:
  build:
    name: Build IPA
    runs-on: macos-latest

    steps:
      # 1. GitHubã‹ã‚‰ã‚ãªãŸã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
      - name: ğŸ“¥ ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
        uses: actions/checkout@v4

      # ã€â˜…ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆã€‘å…ˆã«pnpmã‚’å…¥ã‚Œã‚‹ï¼
      - name: ğŸ“¦ pnpmã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        uses: pnpm/action-setup@v3
        with:
          version: 9

      # 3. ãã®å¾Œã«Node.jsã‚’å…¥ã‚Œã‚‹
      - name: ğŸ› ï¸ Node.jsã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm' # ã“ã‚Œã§ã‚¨ãƒ©ãƒ¼ãŒå‡ºãªããªã‚‹ï¼

      # 4. Expoã®ãƒ“ãƒ«ãƒ‰é“å…·(EAS CLI)ã‚’å…¥ã‚Œã‚‹
      - name: ğŸš€ EAS CLIã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm install -g eas-cli

      # 5. ã‚¢ãƒ—ãƒªã«å¿…è¦ãªéƒ¨å“ã‚’å…¨éƒ¨ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹
      - name: ğŸ“š ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: pnpm install

      # 6. ã€é‡è¦ã€‘ç§˜å¯†ã®éµ(.env)ã‚’ãƒ­ãƒœãƒƒãƒˆã®å…ƒã§å¾©æ´»ã•ã›ã‚‹
      - name: ğŸ”“ .envãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
        env:
          RC_KEY: ${{ secrets.RC_API_KEY_IOS }}
        run: |
          echo "EXPO_PUBLIC_RC_API_KEY_IOS=$RC_KEY" > .env

      # 7. ã„ã‚ˆã„ã‚ˆã‚¢ãƒ—ãƒªæœ¬ä½“ã‚’ä½œæˆï¼ˆãƒ“ãƒ«ãƒ‰ï¼‰ï¼
      - name: ğŸ—ï¸ iPhoneã‚¢ãƒ—ãƒª(IPA)ã‚’ãƒ“ãƒ«ãƒ‰
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: eas build --platform ios --profile production --local --non-interactive --output ./DotChain.ipa

      # 8. å®Œæˆã—ãŸã‚¢ãƒ—ãƒªã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã‚‹ã‚ˆã†ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
      - name: ğŸ“¤ å®Œæˆå“ã‚’ä¿å­˜
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa-file
          path: ./DotChain.ipa