name: Build and Submit to TestFlight

on:
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã®ã¿

jobs:
  build_and_submit:
    name: Build & Submit IPA
    runs-on: macos-latest # ç„¡æ–™æ ã®Macã‚’ä½¿ç”¨

    steps:
      # 1. ã‚³ãƒ¼ãƒ‰ã®æº–å‚™
      - name: ğŸ“¥ ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
        uses: actions/checkout@v4

      - name: ğŸ“¦ pnpmã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: ğŸ› ï¸ Node.jsã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      # 2. é“å…·ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: ğŸš€ EAS CLIã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm install -g eas-cli

      - name: ğŸ“š ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: pnpm install

      # 3. ãƒ“ãƒ«ãƒ‰ï¼ˆIPAä½œæˆï¼‰
      # --local: GitHubã®Macã§ä½œã‚‹ï¼ˆç„¡æ–™ï¼‰
      # --profile production: eas.jsonã® "store" è¨­å®šã‚’ä½¿ã†
      - name: ğŸ—ï¸ iPhoneã‚¢ãƒ—ãƒª(IPA)ã‚’ãƒ“ãƒ«ãƒ‰
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: eas build --platform ios --profile production --local --non-interactive --output=DotChain.ipa

      # â˜…ã“ã®æ¬¡ã« submitï¼ˆTestFlightæå‡ºï¼‰
      - name: ğŸ“¤ TestFlightã«æå‡º (Submit)
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: eas submit --platform ios --path DotChain.ipa --profile production --non-interactive --no-wait

      - name: ğŸ“¤ å®Œæˆå“ã‚’ä¿å­˜ (Artifact)
        uses: actions/upload-artifact@v4
        with:
          name: DotChain-iOS-IPA
          path: DotChain.ipa
          retention-days: 1
