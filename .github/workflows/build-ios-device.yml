name: Build and Submit to TestFlight

on:
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã®ã¿

jobs:
  build_and_submit:
    name: Build & Submit IPA
    runs-on: macos-latest # ç„¡æ–™æ ã®Macã‚’ä½¿ç”¨

    steps:
      # 1. ã‚³ãƒ¼ãƒ‰ã®æº–å‚™
      - name: ğŸ“¥ ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
        uses: actions/checkout@v4

      - name: ğŸ“¦ pnpmã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: ğŸ› ï¸ Node.jsã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      # 2. é“å…·ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: ğŸš€ EAS CLIã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm install -g eas-cli

      - name: ğŸ“š ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: pnpm install

      # 3. ã€é‡è¦ã€‘ç’°å¢ƒå¤‰æ•°ã®ä½œæˆ
      # ã“ã‚ŒãŒãªã„ã¨ã€ã‚¢ãƒ—ãƒªã®ä¸­ã«APIã‚­ãƒ¼ãŒå«ã¾ã‚Œãšã€èµ·å‹•ã—ã¦ã‚‚ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™
      - name: ğŸ”“ .envãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
        run: |
          # å¿…è¦ãªã‚­ãƒ¼ã‚’ã“ã“ã«è¿½åŠ ã—ã¦ãã ã•ã„
          echo "EXPO_PUBLIC_REVENUECAT_IOS_API_KEY=${{ secrets.EXPO_PUBLIC_REVENUECAT_IOS_API_KEY }}" >> .env
          echo "EXPO_PUBLIC_REVENUECAT_ANDROID_API_KEY=${{ secrets.EXPO_PUBLIC_REVENUECAT_ANDROID_API_KEY }}" >> .env
        # æ³¨æ„: GitHubã®Secretsã«ã“ã‚Œã‚‰ã®ã‚­ãƒ¼ã‚’ç™»éŒ²ã—ã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™

      # 4. ãƒ“ãƒ«ãƒ‰ï¼ˆIPAä½œæˆï¼‰
      # --local: GitHubã®Macã§ä½œã‚‹ï¼ˆç„¡æ–™ï¼‰
      # --profile production: eas.jsonã® "store" è¨­å®šã‚’ä½¿ã†
      - name: ğŸ—ï¸ iPhoneã‚¢ãƒ—ãƒª(IPA)ã‚’ãƒ“ãƒ«ãƒ‰
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: eas build --platform ios --profile production --local --non-interactive --output=DotChain.ipa

      # â˜…ã“ã®æ¬¡ã« submitï¼ˆTestFlightæå‡ºï¼‰
      - name: ğŸ“¤ TestFlightã«æå‡º (Submit)
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: eas submit --platform ios --path DotChain.ipa --profile production --non-interactive

      - name: ğŸ“¤ å®Œæˆå“ã‚’ä¿å­˜ (Artifact)
        uses: actions/upload-artifact@v4
        with:
          name: DotChain-iOS-IPA
          path: DotChain.ipa