# 5_テスト仕様書（DotChain v1.0）

---

## 1. 本書の目的と位置づけ

本書「5_テスト仕様書.md」は、DotChain v1.0 に対して

- **何を / どこまで / どうやってテストするか**
- **どのケースを通れば「リリースOK」と判断できるか**

を明確にするためのドキュメントです。

他仕様との関係：

- 0_プロダクト戦略.md … テストで守るべき「価値」「KPI」の方向性
- 1_基本仕様書.md … テスト対象となる機能（F-01〜F-07）の一覧
- 1.5_UI_画面設計書.md … 画面ごとのUI要件
- 2_機能設計書.md … 各機能のフロー・条件分岐
- 3_詳細設計書.md … Store / Repository / Service / コンポーネント構造
- **5_テスト仕様書.md … 上記を「検証するためのチェックリスト」とテスト手順**

このファイルだけで、

- 「どの機能をどの端末でどうテストすればよいか」
- 「Free / Pro / 多言語 / 課金 / 広告まわりをどこまで確認すればよいか」

が分かる状態を目標とします。

---

## 2. テスト対象・前提条件

### 2-1. 対象バージョン

- アプリ：DotChain v1.0.0
- 対象OS：
  - iOS 15 以上
  - Android 8.0（API 26）以上

### 2-2. テスト対象機能

- F-01：習慣実行の記録（ワンタップ & チェーン）
- F-02：習慣の追加・編集・削除
- F-03：設定変更（テーマ・言語・演出など）
- F-04：Proプラン購入 / 課金復元（RevenueCat連携）
- F-05：多言語切替（18言語）
- F-06：Proプラン効果の反映（制限解除）
- F-07：バナー広告表示（AdMob）

### 2-3. 非対象（v1.0ではテストしない機能）

- ホームウィジェット / ウィジェット連携
- アプリアイコン変更機能
- RTL レイアウト（右→左言語）
- OSSライセンス専用画面

※今後復活させる場合は、仕様書0〜3と本書を改版すること。

---

## 3. テスト種別と方針

### 3-1. テスト種別

1. **単体テスト（Unit Test）**
   - 対象：関数・Store・Repositoryなど、アプリの一部分
   - 目的：その機能単体が仕様通りに動くか

2. **結合テスト（Integration Test）**
   - 対象：Store + Repository + DB など複数の部品の組み合わせ
   - 目的：組み合わせても期待通り動くか

3. **E2Eテスト（End to End Test）**
   - 対象：アプリ全体をユーザーの操作に近い形でテスト
   - ツール：Maestro（想定）
   - 目的：「起動→操作→結果」が問題なく動くか

4. **手動テスト（Manual Test）**
   - テスターが実機やエミュレータで実際に触って確認
   - 特に UI の見た目、体験、細かいレイアウトは手動で確認する。

### 3-2. テストの優先度とカバレッジ

- 単体＋結合テスト：
  - F-01〜F-06 に関わる **ドメインロジック**（習慣ログ、Free/Pro制限、日付計算、Pro判定）はテストを書くことを必須とする。
  - 目標：ドメインロジック部分は **ステートメントカバレッジ 80%以上**。

- E2Eテスト：
  - 最低限、以下の**主要フロー4本**はスクリプト化する（詳細は7章）：
    - UC-01：毎日の習慣を記録する
    - UC-02：Free状態での習慣追加と上限ダイアログ表示
    - UC-03：Pro購入後の広告非表示・テーマ開放
    - UC-04：言語切替の反映

- 手動テスト：
  - 全画面（S-01〜S-04）のUI、レイアウト、多言語表示は毎リリース時に目視確認する。

---

## 4. テスト環境

### 4-1. 端末・OS 組み合わせ

最低限、以下の組み合わせで確認する（余裕があれば追加）。

| OS      | バージョン例 | 端末例                     |
|---------|--------------|----------------------------|
| iOS     | 17.x         | iPhone 14 / iPhone SE2     |
| Android | 14.x         | Pixel 7 / ミドルレンジ端末 |

### 4-2. ネットワーク条件

- 課金関連（F-04）は **オンライン環境** でテスト。
- ネットワークエラー時の挙動も簡易的に確認：
  - 機内モード / オフライン状態で Pro購入・復元を試し、トースト表示されるかを確認する。

---

## 5. テスト観点一覧（機能別）

ここでは「何を確認するか」の観点を機能ごとに整理します。

### 5-1. F-01：習慣実行の記録

- 1タップで「今日」の状態が `done` に変わるか
- 再タップで `not_done` に戻るか
- ログが保存され、アプリ再起動後も状態が保持されているか
- カレンダー（ヒートマップ）に反映されるか
- DB書き込みエラー時に、トグル状態が元に戻り、トースト表示されるか

### 5-2. F-02：習慣の追加・編集・削除

- 新規追加で Habit が作成され、ホームに即表示されるか
- 編集で名称・アイコン・カラーが更新されるか
- 削除すると、ホーム一覧から消え、対応する HabitLog も削除されるか
- Free状態で3件まで追加可能であること
- Free状態で4件目の保存を試みると、
  - Habit は保存されない
  - 上限ダイアログが表示される
  - 「Proを確認する」を押すと S-04 Pro画面へ遷移する

### 5-3. F-03：設定変更

- テーマ切替：
  - Free：Dark以外をタップすると S-04 に遷移し、テーマは変わらない
  - Pro：Neon Pink / Cyber Blue を選択すると即時反映
- ヒートマップ期間変更：30→60→180→365 日に切り替わること
- 効果音 / 振動 / エフェクト：
  - トグルON/OFFで挙動が変わる（目視＋体感）
- 購入を復元：
  - Pro購入済みアカウントで復元すると Pro状態になる
  - 購入履歴がない場合はトーストで「復元できる購入は見つかりませんでした」

### 5-4. F-04：Pro購入 / 復元

- 月額 / 年額プランのどちらでも購入できること（サンドボックス環境）
- 購入成功時：
  - `isPro` が true になり、広告が消える
  - テーマが全開放される
  - 成功メッセージ（Alert）が表示される
- 購入失敗時（キャンセル / ネットワークエラーなど）：
  - `isPro` は false のまま
  - Toast でエラー文言が表示される
- 復元成功時：
  - isPro が true になる
- 復元失敗時：
  - isPro は変わらない
  - 適切なトーストが出る

### 5-5. F-05：多言語切替（18言語）

- 言語リストに18言語が表示される（アラビア語は含まれない）
- 言語を切り替えると、現在表示中の画面の文言が即時に変わる
- アプリ再起動後も選択した言語が維持される
- ハードコード文字列が残っていない（主要画面で目視チェック）

### 5-6. F-06：Pro効果の反映

- Free→Pro になった瞬間に以下が変化する：
  - S-01 下部のバナー広告が消える
  - S-02 テーマ設定でロックが解除される
  - Freeで上限に達した状態でも、新規習慣追加が可能になる
- Pro失効時（RevenueCat同期で失効が判明したケースを想定）：
  - isPro が false に変わる
  - テーマが Dark に戻る（Neon/CyberBlue利用中だった場合）
  - 広告が再表示される

### 5-7. F-07：バナー広告表示

- Free状態：
  - S-01の下端にバナー広告が表示される（テストIDで確認）
- Pro状態：
  - バナー広告が一切表示されない
- 広告取得失敗時：
  - アプリがクラッシュしない
  - 画面下部が空白になるだけで他動作に影響しない

### 5-8. 非機能テスト観点

- パフォーマンス：
  - 10習慣×365日分のログがあっても、ホーム画面の初期表示が3秒以内で表示されること（目安）。
- データ永続性：
  - アプリ再起動後も、習慣とログ・設定が保持されていること。
- セキュリティ：
  - ProState / Settings が SecureStore に保存され、AsyncStorage の平文に残っていないこと（開発者ツールで確認）。

---

## 6. テストケース詳細（代表例）

ここでは、実際のテスト手順を「テストケース」として具体化します。

### 6-1. 記法

各テストケースは以下の形式で記載します。

- **TC-ID**：Test Case ID（`TC-F01-001` など）
- **対象機能**：F-xx / 画面ID（S-0x）
- **目的**：何を確認するテストか
- **前提条件**：テスト開始前に揃える状態
- **手順**：操作手順
- **期待結果**：どうなれば「OK」と判断できるか

### 6-2. F-01：習慣実行の記録

#### TC-F01-001：新規記録（done）

- 対象機能：F-01, S-01
- 目的：1タップで当日ログが `done` になることを確認
- 前提条件：
  - Free状態 / Pro状態どちらでも良い
  - 習慣が1件以上登録されている
  - 今日のログはまだ何もついていない
- 手順：
  1. アプリを起動し、S-01 ホーム画面を表示する
  2. 習慣一覧から任意の習慣のトグルボタンを1回タップ
- 期待結果：
  - 該当習慣の行が「達成状態」の見た目に変わる
  - カレンダー上の今日の日付にドット（達成マーク）が表示される
  - アプリを再起動しても、その習慣の今日の状態が達成のままになっている

#### TC-F01-002：取消（not_done）

- 対象機能：F-01, S-01
- 目的：再タップで `not_done` に戻ることを確認
- 前提条件：
  - TC-F01-001 実施後の状態（同日の同習慣が達成になっている）
- 手順：
  1. 達成状態のトグルボタンを再度タップ
- 期待結果：
  - 該当習慣の行が「未達成」の見た目に戻る
  - カレンダー上の今日のドットが消える or 非達成色になる

### 6-3. F-02：習慣追加・Free 3件制限

#### TC-F02-001：Freeで3件まで追加可能

- 対象機能：F-02, F-06, S-01, S-03
- 目的：Free状態で3件までは正常に追加できること
- 前提条件：
  - `isPro == false`（Free状態）
  - 現在の習慣数が0件
- 手順：
  1. S-01 の FAB「＋」をタップ
  2. 名称・アイコン・カラーを入力して保存（これを3回繰り返す）
- 期待結果：
  - 3件すべてがホーム一覧に表示される
  - エラーや警告は表示されない

#### TC-F02-002：Freeで4件目追加時に上限ダイアログ

- 対象機能：F-02, F-06, S-01, S-03, S-04
- 目的：4件目の保存時に上限ダイアログが表示され、保存されないこと
- 前提条件：
  - `isPro == false`（Free）
  - すでに3件の習慣が登録済み
- 手順：
  1. S-01 の FAB「＋」をタップ
  2. 新しい習慣名などを入力
  3. 「保存」をタップ
- 期待結果：
  - 新規習慣は保存されない（ホームの件数は3件のまま）
  - ダイアログが表示される：
    - タイトル：「無料版の上限に達しました」
    - 本文：「無料版では習慣は3つまでです。Proにアップグレードすると無制限に追加できます。」
  - 「Proを確認する」ボタンを押すと、S-04 Pro画面が表示される

### 6-4. F-03：設定変更

#### TC-F03-001：Freeのテーマ切替（ロック）

- 対象機能：F-03, F-06, S-02, S-04
- 目的：FreeではDark以外のテーマ選択でPro画面に誘導されること
- 前提条件：
  - `isPro == false`
- 手順：
  1. S-02 設定画面を開く
  2. テーマ設定項目から「Neon Pink」をタップ
- 期待結果：
  - テーマは Dark のまま変わらない
  - S-04 Pro画面に遷移する

#### TC-F03-002：Proのテーマ切替

- 対象機能：F-03, F-06, S-02
- 目的：Pro状態ではテーマが即時切り替わること
- 前提条件：
  - `isPro == true`
- 手順：
  1. S-02 設定画面を開く
  2. テーマ項目から「Neon Pink」をタップ
- 期待結果：
  - アプリ全体の配色がNeon Pinkテーマに切り替わる
  - 再起動後もNeon Pinkが維持される

### 6-5. F-04：Pro購入 / 復元

#### TC-F04-001：月額プラン購入成功

- 対象機能：F-04, F-06, F-07, S-04, S-01, S-02
- 目的：月額Pro購入成功時の挙動を確認
- 前提条件：
  - サンドボックス環境でテスト用ユーザーを用意
  - `isPro == false` であること
- 手順：
  1. S-04 Pro画面を開く
  2. 月額プランカードをタップ
  3. ストアの課金ダイアログで購入を承認
- 期待結果：
  - 購入完了後、成功メッセージ（Alert）が表示される
  - `isPro` が true になる
  - S-01 に戻るとバナー広告が表示されない
  - S-02 のテーマ設定でNeon/CyberBlueが選択可能になる

#### TC-F04-002：購入キャンセル時のトースト

- 対象機能：F-04, S-04
- 目的：購入キャンセル時にトーストで通知されること
- 前提条件：
  - `isPro == false`
- 手順：
  1. S-04 Pro画面を開く
  2. プランカードをタップ
  3. ストアダイアログで「キャンセル」を選択
- 期待結果：
  - `isPro` は false のまま
  - Toastで「購入に失敗しました」もしくは相応のメッセージが表示される

### 6-6. F-05：多言語切替

#### TC-F05-001：言語切替の即時反映

- 対象機能：F-05, S-02, 全画面
- 目的：言語変更後、即時に文言が変わること
- 前提条件：
  - 初期言語を英語 (en) に設定している
- 手順：
  1. S-02 設定画面を開く
  2. 「Language」から「日本語 (ja)」をタップ
  3. S-01 ホーム画面に戻る
- 期待結果：
  - S-02 内のラベルが日本語に変わる
  - S-01 のタイトル・ボタン文言なども日本語になる

#### TC-F05-002：アプリ再起動後の維持

- 対象機能：F-05, F-03
- 目的：選択した言語が永続化されていること
- 前提条件：
  - TC-F05-001 で言語を日本語にした状態
- 手順：
  1. アプリを完全に終了する
  2. 再度アプリを起動
- 期待結果：
  - 起動直後から日本語で表示される

### 6-7. F-06：Pro効果の反映

#### TC-F06-001：Pro化後の広告非表示

- 対象機能：F-06, F-07, S-01
- 目的：Pro状態で広告が消えること
- 前提条件：
  - Free状態で広告が表示されている状態
  - TC-F04-001 でPro化している
- 手順：
  1. S-01 ホーム画面を表示する
- 期待結果：
  - 画面下部にバナー広告が表示されない

### 6-8. F-07：バナー広告

#### TC-F07-001：Freeのバナー表示

- 対象機能：F-07, S-01
- 目的：Freeで広告が表示されること
- 前提条件：
  - `isPro == false`
  - テスト用AdMobユニットID設定済み
- 手順：
  1. S-01 ホーム画面を表示
- 期待結果：
  - 数秒以内に画面下部にテスト広告が表示される

---

## 7. E2Eテストシナリオ（Maestro想定）

ここでは、Maestro 等のE2Eツールを使って自動化すべきシナリオをまとめます。

### 7-1. シナリオ一覧

1. **Scenario-01：初回起動〜習慣追加〜記録**
2. **Scenario-02：Freeで3件上限まで追加→4件目で上限ダイアログ**
3. **Scenario-03：Pro購入→広告非表示・テーマ開放**
4. **Scenario-04：言語切替→画面文言即時変更**

### 7-2. Maestro コマンドの意味

```bash
pnpm maestro test
```

- `maestro`：モバイルアプリの画面操作を自動化するツール
- `maestro test`：定義済みのフロー（YAMLファイルなど）に従ってアプリを自動操作し、
  - 画面表示
  - ボタンタップ
  - テキスト入力
  - スクリーンショット

などを実行するコマンドです。

---

## 8. 単体テスト・結合テストの範囲とコマンド

### 8-1. テスト対象モジュール

- `logRepository.upsert`：
  - 同じ habitId+date に対して `done` / `not_done` を切り替えた時に、最新状態だけが保存されるか
- Free/Pro 判定ロジック：
  - 「Freeかつ習慣数>=3 → 保存NG」「その他 → 保存OK」
- 日付関連：
  - `todayKey` が端末ローカル日付の `YYYY-MM-DD` になること

### 8-2. コマンドと意味

```bash
pnpm test
```

- `pnpm`：パッケージマネージャ
- `test`：`package.json` に定義されたテストスクリプトを実行
- 役割：
  - すべてのユニットテスト・コンポーネントテストを実行し、仕様から逸脱していないかを自動チェックする

---

## 9. 手動テストチェックリスト（リリース前）

リリース前に、最低限以下の項目は **実機で** 手動確認することを推奨します。

### 9-1. UI・レイアウト

- S-01〜S-04 各画面で、
  - 文字切れ・はみ出しがない
  - テーマごとの配色が崩れていない
  - ボタンタップ領域が狭すぎない

### 9-2. Free / Pro まわり

- Freeで3件上限 → 4件目でダイアログ
- Pro化後、広告・テーマ・制限が想定通り切り替わる

### 9-3. 多言語

- 少なくとも以下の言語でざっと画面をなめる：
  - 日本語 / 英語 / 中国語（簡体） / ドイツ語 / トルコ語 など

### 9-4. 異常系

- 機内モードで Pro購入・復元 → トーストでエラー表示
- ストアキャンセル → トースト表示

---

## 10. 参考資料・アプリ

テスト観点やフローの参考としたアプリ・ドキュメント：

- Loop Habit Tracker  
  https://loophabits.org/
- Streaks  
  https://streaksapp.com/
- Habitify  
  https://habitify.me/
- Productive  
  https://productiveapp.io/
- RevenueCat ドキュメント（サンドボックステスト）  
  https://www.revenuecat.com/docs/testing
- Google AdMob テスト広告  
  https://developers.google.com/admob/android/test-ads

---

本「5_テスト仕様書.md」に従ってテストを実施し、

- 重大なバグがない
- Free / Pro / 多言語 / 広告・課金まわりが仕様通り動作する

ことを確認できた場合、DotChain v1.0 はリリース候補とみなします。

