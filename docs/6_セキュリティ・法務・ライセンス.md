# 6_セキュリティ・法務・ライセンス（DotChain v1.0）

---

## 1. 本書の目的と前提

本書「6_セキュリティ・法務・ライセンス.md」は、DotChain v1.0 において

- どのようなユーザーデータを扱うか
- それをどのように守るか（セキュリティ）
- ストア配信に必要なプライバシー・法務まわりをどう整理するか
- OSSライセンスをどのように管理するか

を **定量的・具体的に** 定めるドキュメントです。

> ※本書は開発者向けの技術的な整理であり、正式な法的助言ではありません。ストア申請時は、必要に応じて専門家（弁護士等）の確認を受けることを推奨します。

DotChain v1.0 の前提：

- 単体で動作する **ローカル志向の習慣トラッカーアプリ**
- バックエンドサーバーは持たない
- 外部サービスは以下のみを利用
  - RevenueCat（課金管理）
  - Apple / Google のアプリ内課金（StoreKit / Play Billing 経由）
  - Google AdMob（バナー広告）
- ユーザー登録（メールアドレスやパスワード）は存在しない

この前提の上で、セキュリティ・法務・ライセンス要件を最小限かつ漏れなく定義します。

---

## 2. データ分類と取り扱い方針

### 2-1. データ分類

本アプリで扱うデータを、以下の3区分で整理します。

1. **アプリ内コンテンツ**（ローカルDBに保存）
   - 習慣マスタ（Habit）
     - 例：習慣名、アイコン、カラー、作成日時など
   - 習慣ログ（HabitLog）
     - 例：日付、done/not_done、更新日時

2. **設定情報**
   - Settings（ローカルに保存）
     - 言語、テーマ、効果音ON/OFF、振動ON/OFF、エフェクトON/OFF、ヒートマップ期間
   - ProState
     - isPro（Proかどうか）
     - RevenueCatの匿名ユーザーID
     - 最終チェック日時

3. **外部サービス・SDK が扱う情報**
   - RevenueCat
     - App User ID（匿名ID）
     - 購入履歴・サブスクリプション状態
   - AdMob
     - 広告IDや端末情報など、Googleモバイル広告が必要とする情報
   - Apple / Google ストア
     - 課金時の決済情報（クレジットカードなど）

### 2-2. 個人情報に関する方針

- アプリとして **ユーザーの氏名・メールアドレス・電話番号・住所などの「直接個人が特定できる情報」は一切取得しない**。
- 習慣名やメモなどに個人情報が含まれる可能性はあるが、それはユーザーが任意に入力するテキストであり、アプリ側から積極的に収集・解析はしない。
- 課金情報（クレジットカード番号など）は、Apple / Google / 各ストアの決済システムが扱い、アプリ内や自前サーバーでは保持しない。

### 2-3. データフロー（概念）

- **ローカルのみで完結**：
  - Habit / HabitLog / Settings は端末内に保存され、開発者サーバーには送信されない。

- **課金まわり**：
  - アプリ → RevenueCat → Apple/Google 決済 → RevenueCat → アプリ
  - アプリは RevenueCat SDK 経由で「このユーザーは Pro かどうか」だけを問い合わせるイメージ。

- **広告まわり**：
  - アプリ → AdMob SDK → Google 広告サーバー
  - 広告表示に必要なデータ（端末識別子など）は AdMob SDK に任せる。

---

## 3. データ保存ポリシー

### 3-1. 保存場所

| データ種別   | 保存場所           | 形式              |
|--------------|--------------------|-------------------|
| Habit        | SQLite (habits)    | テーブル行        |
| HabitLog     | SQLite (habit_logs)| テーブル行        |
| Settings     | SecureStore        | JSON文字列        |
| ProState     | SecureStore        | JSON文字列        |

- SQLite：端末内DB。アプリが削除されれば基本的に一緒に削除される。
- SecureStore：端末が提供する暗号化ストレージ。外部アプリから参照されにくい領域。

### 3-2. 保存期間

- Habit / HabitLog / Settings / ProState は **ユーザーがアプリを利用している間** 保存される。
- ユーザーがアプリを削除すると、原則として端末からデータは削除される（OS標準の挙動）。
- 開発者側でサーバー保存しないため、「サーバーから個別削除」はそもそも不要。

### 3-3. ユーザーによる削除の手段

- 習慣データ削除：
  - S-03（習慣編集画面）で「削除」操作を行うと、Habitと紐づくHabitLogがまとめて削除される（ON DELETE CASCADE）。

- 全データ削除：
  - v1.0時点では、アプリ内に「全データ削除」ボタンは持たない。
  - 全削除したい場合は、ユーザーがアプリ自体をアンインストールすることになる。
  - 将来、「アプリ内で全データ削除」機能を追加する場合は、本書および仕様書を改版すること。

---

## 4. セキュリティ設計

### 4-1. ストレージの安全性

- Settings / ProState は **SecureStore** を利用して保存する。
  - これにより、端末ローカルとはいえ平文テキストで外部から簡単には読めないようにする。

- Habit / HabitLog はSQLiteに保存する。
  - 習慣データはセンシティブ度合いが比較的低いと判断している（ただし、ユーザーがどのような名前を設定するかは自由）。
  - 追加で暗号化が必要と判断した場合は、暗号化SQLiteライブラリの導入を検討する（v1.0ではスコープ外）。

### 4-2. 通信の安全性

- RevenueCat / AdMob / ストアとの通信はすべて **HTTPS（TLS）** を前提とする。
- HTTP（暗号化なし）通信は使用しない。

### 4-3. ログ・デバッグ情報

- アプリ内ログ：
  - `logger.info` / `logger.error` で出力する内容には **個人を特定しうる情報を含めない**。
  - 例：
    - OK：`logger.error("Failed to load habits", error)`
    - NG：ユーザーが入力した習慣名全文をログに出す

- クラッシュレポートサービス（Sentry等）は v1.0 では利用しない前提。
  - 将来導入する場合は、プライバシーポリシーの更新および本書の改版を行う。

### 4-4. 不正利用・リバースエンジニアリング対策（最小限）

- バイナリから RevenueCat APIキーやAdMobユニットIDが読めてしまう可能性はあるが、モバイルアプリではある程度許容される前提とする。
- 重要なロジック（サーバー側でしか見せたくないアルゴリズムなど）は、そもそも持たない。

---

## 5. 課金・RevenueCatまわりの取り扱い

### 5-1. App User ID（匿名ID）

- RevenueCatの App User ID は、初回起動時に自動生成される匿名ID（`originalAppUserId`）を利用し、
  - メールアドレスやユーザー名など、個人を直接特定する情報は使わない。

- ProState には以下のみを保存：
  - `isPro: boolean`（Proかどうか）
  - `anonUserId: string | null`（匿名ユーザーID）
  - `lastCheckAt: string | null`（最終同期日時）

### 5-2. 課金情報の扱い

- 課金（クレジットカード情報など）は Apple / Google の各ストアが管理し、アプリや自前サーバーは一切保持しない。
- アプリは RevenueCat SDK を通じて「この匿名IDにPro権限があるか」を問い合わせるのみ。

### 5-3. エラー時の挙動

- 課金購入失敗・復元失敗時：
  - ユーザーには **Toast** でエラーを短く伝える。
  - ログには詳細なエラーコード・メッセージを残すが、個人情報は含めない。

### 5-4. サンドボックスと本番の切り替え

- 開発環境と本番環境で RevenueCat のAPIキーを分ける。
  - `.env` または Expo の設定機構を用いて管理し、ソースコードに直書きしない。
- テスト用ユーザー（サンドボックス）は、リリース前に削除またはリセットする方針とする。

---

## 6. 広告（AdMob）まわり

### 6-1. テスト広告と本番広告

- 開発中：
  - `__DEV__` のときは必ず **テスト用広告ユニットID** を使用する。

- 本番ビルド：
  - 実際の広告ユニットIDを利用するが、ソースコードに直書きせず、設定ファイル経由で注入する。

### 6-2. データの扱い

- AdMob SDKが取得・利用する情報（広告ID、端末情報など）については、Googleのプライバシーポリシーに従う。
- アプリ側から積極的に個人情報を AdMob に送信する処理は持たない。

### 6-3. Pro状態との連動

- `isPro == true` の場合、AdMobコンポーネントをそもそもマウントせず、SDKにリクエストが飛ばないようにする。
- これにより、Proユーザーからの広告データ収集を抑制する。

---

## 7. プライバシーポリシー設計（ドラフト）

この節は、アプリの配信元Webサイトなどに掲載する「プライバシーポリシー」のたたき台としても利用できます。

### 7-1. 想定セクション

1. 取得する情報
2. 情報の利用目的
3. 情報の第三者提供
4. 外部サービス・SDKの利用
5. データの保存期間
6. 利用者の選択（オプトアウト等）
7. お問い合わせ窓口

### 7-2. 取得する情報（例文イメージ）

- アプリ内で作成した習慣名・ログ・設定情報は、ユーザーの端末内にのみ保存され、開発者のサーバーには送信されません。
- アプリは、課金と広告のために次の外部サービスを利用します：
  - RevenueCat（課金状態の管理）
  - Google AdMob（バナー広告の表示）
- これら外部サービスが取得する情報（端末情報や広告IDなど）は、各サービスのプライバシーポリシーに従って取り扱われます。

### 7-3. 利用目的

- 習慣データ：習慣トラッキング機能の提供
- 設定情報：ユーザーが選択した言語・テーマ・演出等の維持
- 課金情報：Pro機能の提供と課金状態の確認
- 広告情報：Freeユーザーへの広告配信

### 7-4. 第三者提供

- 開発者が任意にユーザーデータを第三者へ提供することはありません。
- ただし、RevenueCatやAdMobなどの外部サービスが、それぞれのポリシーに基づきデータを利用する場合があります。

---

## 8. 利用規約・免責（ドラフト）

### 8-1. 利用規約の主なポイント

- 本アプリは「習慣管理・セルフマネジメント」を目的とした一般向けツールです。
- 以下のような点を利用規約として明記することを想定します：
  - アプリに記録された内容の正確性・完全性は保証しない
  - アプリの利用による成果（習慣形成など）を約束するものではない
  - メンタルヘルスや医療行為の代替ではない
  - アプリの不具合によりデータが失われた場合でも、開発者は可能な範囲で修正・アップデートを行うが、損害賠償責任は限定される

### 8-2. 年齢制限

- DotChain は一般向けアプリとして設計するが、
  - ストア上のレーティングは「13歳以上」程度を想定
  - 未成年ユーザーについては、保護者の同意のもと利用することを推奨する文言を利用規約・プライバシーポリシーに含める。

---

## 9. OSSライセンス管理

### 9-1. 依存ライブラリのライセンス把握

- 使用する主要OSS例：
  - React / React Native
  - Expo SDK
  - Zustand
  - Tamagui
  - i18next
  - RevenueCat SDK
  - AdMob SDK など

- これらのライブラリが採用するライセンス（MIT / Apache-2.0 / BSD など）を一覧にまとめる。

### 9-2. 管理方法

- リポジトリ直下に `THIRD_PARTY_LICENSES.md` を配置し、利用している主要OSSのライセンス文を記載する。
- `package.json` の依存関係から自動生成するスクリプトを導入してもよい（v1.0では手動管理でも可）。

### 9-3. アプリ内での表示

- v1.0 では、設定画面からの OSS ライセンス画面（S-02 → Open Source Licenses）は **実装対象外** とする。
- ただし、将来実装する場合に備え、
  - `THIRD_PARTY_LICENSES.md` をそのまま表示できる簡易ビューを作る想定をしておく。

---

## 10. ストア申請時のチェック項目

### 10-1. Apple App Store

- プライバシー「App Privacy」での申告：
  - 「アプリが収集するデータ」には、**アプリ自体はサーバーに送信しない**ため、基本的には「ローカルのみ」を選択。
  - 外部SDK（RevenueCat、AdMob）が扱うデータは、各SDKのドキュメントに従って分類・申告する。
- プライバシーポリシーURL：
  - 配信元サイト上に掲載し、そのURLをApp Store Connectに登録する。

### 10-2. Google Play

- データ セーフティ セクション：
  - 収集・共有するデータの有無を、「自前サーバーなし」「外部SDKあり」の前提で回答。
- プライバシーポリシーURL：
  - App Store同様に、Web上のプライバシーポリシーを登録。

---

## 11. インシデント対応方針（簡易）

ここでは、万が一の不具合やデータ取り扱いに関するインシデントが発生した場合の基本方針を定めます。

1. **検知**
   - ユーザーからの問い合わせ、ストアレビュー、開発者自身のテストなどで不具合を認識。

2. **影響範囲の特定**
   - どのバージョンで、どの機能を使ったユーザーに影響があるかを整理。

3. **暫定対応**
   - 重大なバグの場合はストアから一時的に公開停止も検討。

4. **恒久対応**
   - 修正版を開発し、テスト仕様書に従って再テストを行った上でリリース。

5. **ユーザーへの周知**
   - 必要に応じてストアのアップデート文、Webサイト、Xなどで状況を共有。

---

## 12. 実務におけるコマンドと意味（セキュリティ・法務関連）

### 12-1. 依存ライブラリの確認

```bash
pnpm list
```

- `pnpm list`：現在インストールされているライブラリとそのバージョンを一覧表示するコマンド。
- ライセンス確認の際に、どのライブラリを使っているかを把握するために利用する。

### 12-2. ビルドコマンド（リリース用）

```bash
pnpm expo run:ios --configuration Release
pnpm expo run:android --variant release
```

- `--configuration Release` / `--variant release`：リリースビルド（最適化された本番用ビルド）を作成する指定。
- リリース前には必ずこのビルドで動作確認を行い、テスト仕様書の手動テストチェックリストを実施する。

---

## 13. 参考リンク

実際のプライバシー設定やSDK利用時の参考とするドキュメント・アプリ：

- Apple App Store Review Guidelines  
  https://developer.apple.com/app-store/review/guidelines/
- App Privacy（Apple）  
  https://developer.apple.com/app-store/app-privacy-details/
- Google Play デベロッパーポリシー  
  https://play.google.com/about/developer-content-policy/
- Google Play データ セーフティ  
  https://support.google.com/googleplay/android-developer/answer/10787469
- RevenueCat ドキュメント  
  https://www.revenuecat.com/docs
- Google AdMob ドキュメント  
  https://developers.google.com/admob

---

本「6_セキュリティ・法務・ライセンス.md」をベースに、

- データの流れと保存場所
- どの情報を誰がどの目的で扱うか
- ストア申請時に何を申告する必要があるか

をチーム全員が同じ前提で認識できるようにする。仕様変更や新しいSDKの導入時には、本書も必ず更新し、0〜7の仕様書全体の整合性を保つこと。