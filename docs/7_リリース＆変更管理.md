# 7_リリース＆変更管理（DotChain v1.0）

---

## 1. 本書の目的と位置づけ

本書「7_リリース＆変更管理.md」は、DotChain の

- **バージョンをどう付けるか**（versioning）
- **どの手順でリリースするか**（release flow）
- **仕様変更やバグ修正をどのように管理するか**（change management）

を明確にするためのドキュメントです。

0〜6 までの仕様書が「何を作るか／どう実装するか／どうテストするか／どう守るか」を定義しているのに対し、本書は

> 「**いつ・何を・どのようにリリースし、その履歴をどう残すか**」

を定義します。

このファイルだけを読めば、

- 新しい機能を作ったときに、どのファイルを更新し、どうバージョンを上げ、どうストアに出せばよいか
- バグが見つかったとき、どう修正版を出し、どこに記録すればよいか

が分かる状態を目標とします。

---

## 2. バージョン管理ポリシー

### 2-1. バージョン番号の形式

DotChain のバージョン番号は **Semantic Versioning（セマンティックバージョニング）** に準拠します。

```text
MAJOR.MINOR.PATCH
例: 1.0.0, 1.1.0, 1.1.1 など
```

- **MAJOR**：互換性を壊すような大きな変更（例：データ構造の大幅変更）
- **MINOR**：後方互換を保った機能追加（例：新しい画面や設定項目の追加）
- **PATCH**：バグ修正や微調整（例：UI調整、クラッシュ修正、文言修正）

### 2-2. v1.0.0 の位置づけ

DotChain v1.0.0 では以下を含みます：

- F-01：習慣実行の記録（ワンタップ & チェーン）
- F-02：習慣の追加・編集・削除（Freeは3件まで）
- F-03：設定変更（テーマ / 言語 / 演出 / ヒートマップ期間）
- F-04：Proプラン購入・復元（RevenueCat連携）
- F-05：多言語対応（アラビア語を除く18言語）
- F-06：Proプラン効果（制限解除＋全テーマ開放＋広告OFF）
- F-07：バナー広告（AdMob）

これらの機能セットが「1系」のベースとなり、以後の 1.x.y で拡張・改善を行います。

### 2-3. モバイルストアでのバージョン

- **iOS**：
  - `CFBundleShortVersionString` に `MAJOR.MINOR.PATCH` を設定
  - `CFBundleVersion`（Build番号）は、リリースごとに **整数でインクリメント**（例：1, 2, 3…）

- **Android**：
  - `versionName` に `MAJOR.MINOR.PATCH`
  - `versionCode` は整数でインクリメント（例：100, 101, 102…）。
    - 例：`1.0.0` → `versionCode=100`、`1.0.1` → `101` など、分かりやすい規則を採用。

> **用語メモ**
> - versionName：ユーザーに見えるバージョン名
> - versionCode / Build：ストアが内部的にバージョンの新旧を判定するための番号

---

## 3. ブランチ戦略とリリースフロー

### 3-1. Git ブランチの役割

Git のブランチは、以下の役割で運用します（1人開発でも同じルールで運用すると整理しやすい）：

- `main`：
  - ストアに出している最新バージョン、もしくはリリース候補だけを置くブランチ。
  - `main` の HEAD が「現在の正式版」です。

- `develop`（任意）：
  - 複数の機能開発を並行したい場合に使用する開発用ブランチ。
  - シンプルにしたい場合は、`main`＋`feature` だけ運用でも良い。

- `feature/xxx-yyy`：
  - 機能ごと / 課題ごとに作るブランチ。
  - 例：`feature/pro-purchase-flow`、`feature/admob-banner` など。

### 3-2. 一般的な変更〜リリースまでの流れ

1. **Issue / TODO の起票**
   - 何か変えたいこと（機能追加 / バグ修正）が出たら、
     - `CHANGELOG.md` の「Unreleased」欄、または GitHub Issues 等にメモする。

2. **ブランチ作成**
   - `main` または `develop` からブランチを切る：

   ```bash
   git checkout main
   git pull
   git checkout -b feature/pro-purchase-flow
   ```

   - `git checkout -b`：新しいブランチを作成して、そのブランチに切り替えるコマンド。

3. **実装・テスト**
   - 0〜4 の仕様書に従って実装。
   - `pnpm test` / `pnpm maestro test` などでテストを通す。

4. **`CHANGELOG.md` に追記**
   - 追加・変更・修正内容を **ユーザー視点で** 簡潔に書く。

5. **レビュー・マージ**
   - 自分であっても、PR（Pull Request）を作成して差分を確認。
   - 問題なければ `main` へマージ。

6. **バージョン番号更新**
   - 変更の重要度に応じて `MAJOR.MINOR.PATCH` を決定。
   - `app.json / app.config` / `package.json` 等のバージョンを更新。

7. **タグ付け**

   ```bash
   git tag v1.0.1
   git push origin v1.0.1
   ```

   - `git tag`：特定のコミットに「タグ（目印）」を付けるコマンド。
   - `git push origin v1.0.1`：作成したタグをリモートに送る。

8. **ストア用ビルド作成＆提出**
   - iOS / Android 向けにリリースビルドを作成し、各ストアに提出。
   - 審査通過後に公開。

---

## 4. チェンジログ（変更履歴）の運用

### 4-1. `CHANGELOG.md` の形式

`CHANGELOG.md` は [Keep a Changelog](https://keepachangelog.com/ja/1.1.0/) スタイルを採用します。

基本フォーマット：

```markdown
# Changelog

すべての notable な変更はこのファイルに記録します。

## [Unreleased]

### Added
- 

### Changed
- 

### Fixed
- 

---

## [1.0.0] - 2025-xx-xx

### Added
- 初期リリース（DotChain v1.0.0）
```

- **Added**：新機能の追加
- **Changed**：既存機能の仕様変更
- **Fixed**：バグ修正
- 必要に応じて **Removed**（削除した機能）も追加。

### 4-2. 変更の記載ルール

- 「内部実装の細かい話」ではなく、「ユーザーにとって何が変わるか」を中心に書く。
- 開発メモは Git のコミットメッセージや仕様書（0〜6）のほうに記載する。

例：

```markdown
## [1.1.0] - 2025-03-01

### Added
- S-01 ホーム画面に、1週間の達成率を表示するウィジェットを追加

### Changed
- S-02 設定画面のレイアウトを整理し、「Pro設定」を専用セクションに移動

### Fixed
- 一部言語で、Proプラン説明文が切れて表示される問題を修正
```

---

## 5. リリース前チェックリスト

リリース前に **必ず行うべき項目** をチェックリスト化します。これらは 5_テスト仕様書.md とも連動しています。

### 5-1. 自動テスト

- [ ] `pnpm test` を実行し、すべてのユニットテスト / コンポーネントテストが成功している。
- [ ] `pnpm maestro test`（E2E）が成功している（主要シナリオに対して）。

```bash
pnpm test
pnpm maestro test
```

- `pnpm test`：定義された単体テストを実行
- `pnpm maestro test`：Maestro のスクリプトに従ってE2Eテストを自動実行

### 5-2. 手動テスト

- [ ] iOS 実機（または Simulator）で S-01〜S-04 をひととおり操作し、クラッシュがない。
- [ ] Android 実機（または Emulator）で同様に確認。
- [ ] 無料ユーザーとして：
  - [ ] 習慣3件追加 → 4件目で上限ダイアログ表示。
  - [ ] 広告が表示される。
- [ ] Proユーザーとして：
  - [ ] Pro購入または復元で isPro が有効になる。
  - [ ] 広告が非表示になる。
  - [ ] テーマが全開放される。
- [ ] 言語切替（少なくとも日本語 / 英語 / その他数言語）で文言切れがない。

### 5-3. セキュリティ・法務

- [ ] `.env` に本番用の RevenueCat / AdMob キーが設定されている（テストキーのままになっていない）。
- [ ] `.env` が `.gitignore` に含まれている。
- [ ] プライバシーポリシーURLに変更があれば、ストア側（App Store Connect / Google Play Console）も更新した。

### 5-4. バージョン・メタ情報

- [ ] `app.json` / `app.config` / `package.json` のバージョンを更新した。
- [ ] iOS の `Build` / Android の `versionCode` をインクリメントした。
- [ ] `CHANGELOG.md` の `[Unreleased]` を現在のバージョンとして確定し、日付を入れた。

---

## 6. ストア提出手順（概要）

※ここでは「最低限この順番でやれば毎回迷わない」という観点で手順の骨格だけを定義します。実際の細かい操作（スクリーンショットアップロード等）はストア側マニュアルに従います。

### 6-1. 共通事前準備

1. リリース前チェックリスト（5章）をすべて消化
2. バージョン番号・`CHANGELOG.md` を更新
3. `main` ブランチにマージし、タグを付ける

```bash
git checkout main
git pull
git merge feature/xxx-yyy

# バージョン更新コミット

git commit -am "chore: bump version to 1.0.1"

git tag v1.0.1
git push origin main --tags
```

- `git merge`：指定ブランチの変更を現在のブランチに取り込む。
- `chore`：主にバージョンアップや設定変更など、「機能ではない変更」を表すコミット種別。

### 6-2. iOS（App Store）

ビルド方法は、Expo（EAS）を利用する場合と、Xcode でビルドする場合で異なります。ここでは Expo EAS を例にしたフローを示します。

1. **EASビルド**

   ```bash
   pnpm expo login        # 必要なら
   pnpm expo whoami       # ログイン確認
   pnpm eas build --platform ios --profile production
   ```

   - `eas build`：Expo Application Services を使ってクラウドビルドを行うコマンド。
   - `--platform ios`：iOS向けにビルド。
   - `--profile production`：`eas.json` で定義した本番用設定を使う。

2. **App Store Connect へアップロード**
   - `eas submit --platform ios` などでビルド済みアーカイブを提出（EAS利用時）。

3. **メタ情報の更新**
   - バージョン情報、特徴説明文、スクリーンショットを更新。
   - プライバシーの申告内容を確認（6_セキュリティ・法務・ライセンス.md 参照）。

4. **審査リクエスト**
   - 審査に出し、結果を待つ。

### 6-3. Android（Google Play）

1. **EASビルド**

   ```bash
   pnpm eas build --platform android --profile production
   ```

2. **Google Play Console へのアップロード**
   - 生成された `.aab` を Play Console にアップロード。

3. **リリース情報の入力**
   - バージョン名／コード、リリースノートを入力（`CHANGELOG.md` を参考にする）。
   - データセーフティ・コンテンツレーティング等を確認。

4. **審査・公開**
   - 審査後、段階的または全ユーザーに公開。

---

## 7. 変更管理（仕様変更・バグ修正）

### 7-1. 変更種別

仕様変更・修正は以下の種別に分類します：

- **機能追加（Feature）**：新しいF-xxや、画面の追加など。
- **仕様変更（Change）**：既存機能の挙動を変えるもの。
- **バグ修正（Fix）**：意図しない動作を直すもの。
- **削除（Remove）**：機能をやめる or 非推奨にするもの。

### 7-2. 仕様書との対応

変更が発生したときに、どの仕様書を更新するかを整理します。

| 種別       | 更新が必要なファイル例                             |
|------------|----------------------------------------------------|
| 機能追加   | 0, 1, 1.5, 2, 3, 4, 5, 6, 7                        |
| 仕様変更   | 1, 1.5, 2, 3, 4, 5, 6, 7（0も必要なら更新）       |
| バグ修正   | 3, 4, 5, 7（必要に応じて2も）                      |
| 削除       | 0, 1, 1.5, 2, 3, 4, 5, 6, 7                        |

- **原則**：
  - 仕様を変えたら、必ず 1〜3 を更新する。
  - 実装パターンを変えたら 4。
  - テスト観点が変わるなら 5。
  - データやSDKへの影響があれば 6。
  - リリース済みの振る舞いに影響するなら 7（本書）も更新。

### 7-3. 変更プロセス（ミニマム）

1. 変更の目的を一文で書く（例：「Free上限を3→5件に変更」）。
2. 影響範囲を洗い出す（どの画面・どのStore・どのテストに影響するか）。
3. 仕様書（該当ファイル）を修正する。
4. 実装を更新する。
5. テスト仕様を更新し、テストを実施する。
6. `CHANGELOG.md` に記録する。

---

## 8. ホットフィックス（緊急修正）

### 8-1. ホットフィックスの定義

- ユーザー体験を大きく損なう重大バグ（例：起動クラッシュ／Proユーザーに広告が出てしまう）に対して、
  - 最小限の変更で、早急にストアへ修正を出すこと。

### 8-2. フロー

1. `main` から `hotfix/1.0.1` のようなブランチを切る。

   ```bash
   git checkout main
   git pull
   git checkout -b hotfix/1.0.1
   ```

2. 必要最小限の修正だけを行う。
3. テスト仕様書のうち、影響部分に関連するテストケースのみでもよいので、重点的に回す。
4. `CHANGELOG.md` に `1.0.1` を追加し、Fixed の項目に内容を記載。
5. `main` にマージし、タグ付け＆ストアへ提出。
6. `develop` ブランチがある場合は、`develop` にも同じ修正をマージしておく。

---

## 9. リリース後モニタリング

### 9-1. フィードバックの収集

現時点では分析SDK等は導入しない前提のため、以下の方法でフィードバックを集めます。

- App Store / Google Play のレビュー
- ユーザーからの問い合わせ（WebフォームやXなど）

### 9-2. フィードバックの整理

- レビューで繰り返し指摘される点は、Issue（GitHubなど）として起票し、
  - 「使い勝手に関する改善」
  - 「バグ報告」
  - 「機能要望」

などに分類する。

### 9-3. 次バージョンへの反映

- 次の MINOR / PATCH の計画を立てる際、
  - 0_プロダクト戦略.md の方向性と照らし合わせながら優先度を決定。
  - 採用しないものも明文化しておくと、後から迷わなくて済む。

---

## 10. 参考リンク

リリース・バージョニング・変更管理に関する参考：

- Keep a Changelog  
  https://keepachangelog.com/ja/1.1.0/
- Semantic Versioning 2.0.0  
  https://semver.org/lang/ja/
- Expo EAS Build 公式  
  https://docs.expo.dev/build/introduction/
- Maestro 公式  
  https://maestro.mobile.dev/

---

本「7_リリース＆変更管理.md」に従うことで、DotChain のリリース作業は：

- 毎回同じ手順で迷わず実行できる
- どのバージョンで何が変わったかを後から追いやすい
- 仕様変更やバグ修正が、仕様書（0〜6）と矛盾しない

状態を目指します。

新しい運用ツール（例：CI/CD、クラッシュレポート、分析SDKなど）を導入する場合は、

- 4〜9章の内容を見直し
- 必要に応じて 0〜6 の仕様書も改版

を行い、チーム全体で同じルール・同じ前提を共有してください。