
# 7_リリース＆変更管理.md（DotChain）

## 1. はじめに

### 1.1 本書の目的

このドキュメントは、完成した「DotChain」を**世界中のストア（App Store / Google Play）に安全に出荷（リリース）し、その後の品質を守り続ける**ための手順書です。

- **0_プロダクト戦略**: 「V1.0完成主義」に基づき、無駄な機能追加を行わない運用を守る。
- **6_法務・セキュリティ**: プライバシーポリシーやライセンス表記が最新かを確認する。

### 1.2 DotChain特有のリリース方針

1.  **Slow Rollout（ゆっくり公開）**:
    * いきなり全ユーザーに公開せず、数日かけて徐々に公開範囲を広げます。
2.  **Global Ready（世界同時）**:
    * 19言語すべてのストア情報（スクショ、説明文）を準備してから公開します。
3.  **Frozen Feature（機能凍結）**:
    * リリース後は、**バグ修正以外の機能追加（コードの変更）を原則禁止**します。

---

## 2. バージョン管理ルール

### 2.1 バージョン番号 (Semantic Versioning)

**`Major.Minor.Patch`** （例：`1.0.0`）

| 桁 | 意味 | 上げるタイミング |
| :--- | :--- | :--- |
| **Major** (1.x.x) | 大規模変更 | UIを根本から作り直すなど（基本 `1` のまま）。 |
| **Minor** (x.1.x) | 機能追加 | 新しいウィジェット追加など（原則行わない）。 |
| **Patch** (x.x.1) | バグ修正 | アラビア語レイアウト修正など。**ここがメイン。** |

### 2.2 ビルド番号 (Build Number)

ストアにアップロードするたびに増やす「通し番号」です。

- **iOS**: `ios.buildNumber` (文字列: "1", "2"...)
- **Android**: `android.versionCode` (整数: 1, 2...)

> **鉄の掟**: リリース審査に落ちて修正版を再アップロードする時は、バージョン(`1.0.0`)はそのままで、**ビルド番号だけ**を上げてください。

---

## 3. リリース手順（Release Flow）

### 3.1 Step 0: 準備フェーズ

1.  **バージョン決定**: 今回出すバージョン（例: `1.0.1`）を確定する。
2.  **リリースノート作成**: `docs/release-notes.md` に変更点を記入する。
    * *多言語対応*: 英語、日本語、アラビア語など主要言語で「何が変わったか」を翻訳しておく。
3.  **法務チェック**: 
    * 新しいライブラリを追加したか？ → ライセンス表記を更新。
    * データの扱いを変えたか？ → プライバシーポリシーを更新。

### 3.2 Step 1: 最終テスト (The Final Gate)

以下のコマンドを順に実行し、**全て成功（緑色）**させること。一つでも赤なら中止。

```bash
# 1. コードの書き方チェック
pnpm lint

# 2. 型の矛盾チェック
pnpm type-check

# 3. ロジックのテスト
pnpm test

# 4. 全体動作テスト (E2E)
pnpm test:e2e
````

### 3.3 Step 2: ビルド作成 (Build)

#### Android (AABファイル)

```bash
# バージョン番号を更新してから実行
pnpm build:android
```

  * **成果物**: `dist/android/app-dotchain-v1.0.1.aab`
  * **確認**: ファイルサイズが異常に大きくないか（目安: 10〜30MB）確認。

#### iOS (IPAファイル)

GitHub Actionsを使ってクラウドでビルドします。

1.  `main` ブランチにタグを打つ。
    ```bash
    git tag v1.0.1
    git push origin v1.0.1
    ```
2.  GitHub上で `ios-build` アクションが自動開始される。
3.  完了後、ArtifactsからIPAファイルをダウンロードし `dist/ios/` に保存。

### 3.4 Step 3: ストアへのアップロードと段階的公開

#### Google Play Console

1.  「製品版」トラックで「新しいリリースを作成」。
2.  AABファイルをアップロード。
3.  \*\*「段階的公開（Staged Rollout）」\*\*を選択し、**5%** から開始する。
4.  クラッシュ率を見ながら、数日かけて 10% → 20% → 50% → 100% と増やす。

#### App Store Connect

1.  TransporterアプリでIPAをアップロード。
2.  TestFlightで最終実機確認。
3.  審査へ提出。
4.  \*\*「段階的リリース（Phased Release）」\*\*をオンにする（7日間かけて自動で広がる）。

-----

## 4\. 変更管理と緊急対応

### 4.1 変更履歴の記録

`docs/release-notes.md` には、ユーザー向けだけでなく「開発者向け」のメモも残します。

**記入例**:

```markdown
## v1.0.1 (2025-12-10)
**修正**
- [Fix] アラビア語環境で設定ボタンが重なるバグを修正 (commit: a1b2c3)
- [Imp] 起動時のロゴアニメーションを0.2秒短縮

**内部変更**
- RevenueCat SDKを v7.0 にアップデート
```

### 4.2 緊急時の対応 (Hotfix)

リリース直後に「アプリが起動しない」などの致命的バグ（P1）が見つかった場合。

1.  **公開停止**: ストアの管理画面で、段階的公開を\*\*「一時停止（Pause）」\*\*する（全ユーザーへの被害を防ぐ）。
2.  **ブランチ作成**: `main` から `hotfix/v1.0.2` を作成。
3.  **修正**: 原因箇所**のみ**を修正する（他のリファクタリングなどは絶対に行わない）。
4.  **テスト**: 修正箇所と起動フローを重点的にテスト。
5.  **即時リリース**: バージョンを `1.0.2` に上げ、審査の「緊急リクエスト」を使用して最速で公開する。

-----

## 5\. コマンドチートシート（リリース用）

| コマンド | 意味 | いつ使う？ |
| :--- | :--- | :--- |
| `pnpm version patch` | パッチバージョン(z)を上げる | バグ修正時 |
| `pnpm version minor` | マイナーバージョン(y)を上げる | 機能追加時 |
| `pnpm build:android` | Android用ファイルを作る | ストア提出前 |
| `git tag v1.0.0` | バージョンの目印を付ける | iOSビルド開始時 |
| `git push origin --tags` | 目印をGitHubに送る | iOSビルド開始時 |

-----

## 6\. リリース前最終チェックリスト（指差し確認）

提出ボタンを押す前に、深呼吸して確認してください。

  * [ ] **バージョン**: `package.json`, `app.json` の数字は合っているか？
  * [ ] **ビルド番号**: 前回より数字が増えているか？（これ、よく忘れます）
  * [ ] **テスト**: `pnpm test:e2e` は完走したか？
  * [ ] **実機確認**: iOS/Android両方の実機で、ハプティクス（振動）は正常か？
  * [ ] **多言語**: アラビア語設定でレイアウトが反転しているか？英語で文字化けしていないか？
  * [ ] **法務**: プライバシーポリシーのURLリンクは切れていないか？
  * [ ] **ストア情報**: スクリーンショットに「開発中のダミー画像」や「デバッグ用文字」が写り込んでいないか？

-----



### 🎓 小中学生向け：用語と仕組みの解説

この設計書に出てくる、リリースの「プロの技」を解説します。

1.  **Phased Release (段階的公開)**
    * **これ何？**: アプリを「少しずつ」配る仕組み。
    * **例**: 最初の日は、世界中のユーザーのうち「たった1%の人」だけにアップデートが届きます。もしそこでバグが見つかったら、すぐに配るのを止めれば、残り99%の人は無事です。プロは必ずこれをやります。

2.  **Hotfix (ホットフィックス)**
    * **これ何？**: 「緊急手術」のこと。
    * **役割**: 普段のアップデートはじっくり準備しますが、ホットフィックスは「今すぐ直さないとヤバい！」という時だけ行う、スピード勝負の修正です。

3.  **Build Number (ビルド番号)**
    * **これ何？**: 「提出した回数」のカウンター。
    * **役割**: バージョン `1.0.0` のままでも、中身をちょっと直して再提出したい時がありますよね？そんな時に、この番号だけ `1` → `2` と増やして区別します。

これで、DotChainの全資料が完成しました。
戦略からリリースまで、一貫した思想で作られたこの設計図は、あなたの強力な武器になります。
あとは自信を持って、開発を進めてください。世界があなたのアプリを待っています！
