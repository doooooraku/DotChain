
# 3_詳細設計書.md（DotChain）

## 1. はじめに

### 1.1 本書の目的

このドキュメントは、アプリ「DotChain」を実際にプログラミングするための**「プログラムの設計図（青写真）」**です。

- **0_プロダクト戦略**: コンセプト（快感、ミニマル）
- **1_基本仕様書**: 機能一覧
- **2_機能設計書**: 動きのルール
- **UI_画面設計書**: 見た目

これら全ての要求を満たすために、**「どのフォルダに、どんなファイルを作り、どんなコードを書くか」**を完全に定義します。エンジニア（あなた）は、この通りにファイルを作成していけばアプリが完成します。

### 1.2 技術スタック（使用する道具）

- **Framework**: Expo SDK 54 / React Native 0.81
- **Language**: TypeScript
- **UI**: Tamagui (高速UI)
- **DB**: SQLite (expo-sqlite)
- **State**: Zustand (状態管理)
- **Sensory**: expo-haptics (振動), expo-av (音)
- **Revenue**: RevenueCat (課金)
- **Ads**: AdMob (広告)

### 1.3 用語解説（初心者向け）

- **モジュール (Module)**: 特定の仕事をする「部品」。ファイル1つ1つのこと。
- **フック (Hook)**: `use〇〇` という名前の関数。「データを取る」「計算する」などのロジック（頭脳）をまとめたもの。
- **エンティティ (Entity)**: 保存するデータの「形」。例：「習慣」には「名前」と「アイコン」が必要、という決まり。
- **ディープリンク (Deep Link)**: ウィジェットなど、外からアプリの特定の場所を直接開くためのURL（例: `dotchain://record/123`）。

---

## 2. ディレクトリ構成（フォルダの地図）

App Factory共通ルールに基づき、DotChain用に最適化した構成です。

```text
src/
  features/       (機能ごとのパック)
    habit/        (習慣管理・記録)
    settings/     (設定画面)
    onboarding/   (初回ガイド)
  core/           (アプリの核となる機能)
    sensory/      (★重要: 感覚フィードバック)
    i18n/         (多言語・RTL)
    db/           (データベース接続)
    ads/          (広告制御)
    subscription/ (課金管理)
  ui/             (共通のデザイン部品)
    theme/        (色・フォント)
    components/   (ボタン・カード等)
  stores/         (アプリ全体の状態)
  hooks/          (共通のロジック)
  app/            (画面とルーティング - Expo Router)
````

-----

## 3\. 画面・ルーティング詳細 (`app/`)

Expo Routerを使用します。ファイル構造がそのまま画面になります。

| パス | 役割 | 関連機能ID |
| :--- | :--- | :--- |
| **`app/_layout.tsx`** | **アプリの枠組み**。プロバイダー（設定、DB、テーマ）の設定や、ディープリンクの監視を行う。 | F-06, F-08 |
| **`app/index.tsx`** | **S-01 ホーム画面**。習慣リストとヒートマップを表示。 | F-01, F-05 |
| **`app/habit/edit.tsx`** | **S-03 編集画面**（モーダル）。習慣の追加・修正。 | F-02 |
| **`app/settings/index.tsx`** | **S-02 設定画面**（モーダル）。言語や音の設定。 | F-03, F-09 |
| **`app/pro/index.tsx`** | **S-04 課金画面**。Proプラン購入。 | F-04 |

-----

## 4\. モジュール詳細設計

### 4.1 `src/core/sensory/` （感覚フィードバック）

\*\*DotChainの命（魂）\*\*となるフォルダです。ここに「気持ちよさ」を集約します。

| ファイル名 | 役割 |
| :--- | :--- |
| **`HapticManager.ts`** | 振動を管理する。`playPop()`（記録時）, `playSuccess()`（達成時）などの関数を持つ。設定でOFFなら振動させない制御もここで行う。 |
| **`SoundManager.ts`** | 効果音を管理する。音ファイルを読み込み、`playPop()`などで再生する。連打時の音切れを防ぐ。 |
| **`SensoryFeedback.ts`** | 上記2つをまとめて呼び出す便利関数。`triggerImpact()` を呼べば音と振動が同時に出る。 |

### 4.2 `src/features/habit/` （習慣機能）

| 種類 | ファイル名 | 役割 |
| :--- | :--- | :--- |
| Component | **`HabitButton.tsx`** | 巨大ボタン。アニメーション（縮む・光る）とパーティクル（紙吹雪）を制御する。 |
| Component | **`HeatmapChain.tsx`** | 過去ログをドットで描画する。 |
| Hook | **`useHabitRecord.ts`** | **最重要ロジック**。ボタンが押されたら「①Sensoryを実行」「②UIを更新」「③DBに保存」を順に行う（楽観的UI）。 |
| DB | **`habitTable.ts`** | `habits` テーブルの読み書き。 |
| DB | **`logTable.ts`** | `logs` テーブルの読み書き。 |

### 4.3 `src/core/i18n/` （多言語・RTL）

| ファイル名 | 役割 |
| :--- | :--- |
| **`i18n.ts`** | 19言語の辞書ファイルを読み込む設定。 |
| **`LayoutManager.ts`** | アラビア語の時に `I18nManager.forceRTL(true)` を実行し、アプリをリロードせずにレイアウトを反転させる仕組み。 |

### 4.4 `src/db/` （データベース）

| ファイル名 | 役割 |
| :--- | :--- |
| **`database.ts`** | SQLiteデータベース (`dotchain.db`) を開く。 |
| **`schema.ts`** | テーブル作成SQL。アプリ起動時にテーブルがない場合は自動作成する。 |

-----

## 5\. データモデル設計（SQLite）

### 5.1 テーブル: `habits` （習慣）

| カラム名 | 型 | 説明 | 例 |
| :--- | :--- | :--- | :--- |
| `id` | TEXT | UUID (主キー) | "a1b2..." |
| `title` | TEXT | 習慣名 | "Water" |
| `icon` | TEXT | 絵文字 | "💧" |
| `color` | TEXT | テーマカラーID | "neon\_blue" |
| `createdAt` | TEXT | 作成日時 | "2025-01-01..." |

### 5.2 テーブル: `logs` （記録）

| カラム名 | 型 | 説明 | 例 |
| :--- | :--- | :--- | :--- |
| `id` | TEXT | UUID (主キー) | "x9y8..." |
| `habitId` | TEXT | 習慣ID (外部キー) | "a1b2..." |
| `date` | TEXT | **記録日 (YYYY-MM-DD)** | "2025-01-01" |
| `timestamp` | TEXT | 正確な打刻日時 | "2025-01-01T09:00:00" |

> **ポイント**: `date` カラムに日付文字列を入れておくことで、「今日やったか？」の検索を高速化します。

### 5.3 日付・日時フォーマット規約（統一ルール）

| 項目 | 格納カラム | フォーマット | 例 | 備考 |
| :--- | :--- | :--- | :--- | :--- |
| **日付** | `logs.date` | `YYYY-MM-DD`（端末ローカル日付をゼロ埋め） | `2025-11-26` | 1日1レコード判定に使う。タイムゾーンずれを防ぐため `getLocalDateKey` で生成し、`toISOString()` は使わない。 |
| **作成日時** | `habits.createdAt` | ISO8601日時（UTC, Z付き） | `2025-11-26T10:15:30.000Z` | 習慣が作られた瞬間。 |
| **打刻日時** | `logs.timestamp` | ISO8601日時（UTC, Z付き） | `2025-11-26T10:20:05.123Z` | ボタンを押した瞬間。並べ替えやデバッグで使う。 |

- 文字列（TEXT）で保存する理由  
  - 仕様書どおり「今日やったか」「直近14日」を素早く判定でき、人が読んで理解しやすい。  
  - 日付キーは端末ローカルタイムで計算し、**朝に押しても前日扱いにならない**ようにする（Heatmap / DB / 状態を同じキーで統一）。  
  - `createdAt` と `timestamp` は UTC の ISO8601 に揃え、順序付けやデバッグ時の比較を安定させる。  
- 将来、重い集計やグラフで性能が問題になったら、`timestamp` を UNIX 時間（INTEGER秒/ミリ秒）へマイグレーションする方針で検討する。

### 5.4 バリデーションとエラー処理の方針
- **必須項目**: `habits.title` は空文字・空白のみを禁止する。DB層で `TITLE_REQUIRED` エラーを投げる。
- **エラーの流れ**:  
  1) DB層（`habitTable.ts`）: 失敗時は `console.error` で記録し、エラーをそのまま `throw`。  
  2) 状態層（`habitStore.ts`）: catchして `error` ストアにメッセージを入れる（Toastで表示）、必要ならサウンド/ハプティクスをエラー用に鳴らす。  
  3) UI層: ストアの `error` を購読し、トーストやダイアログでユーザーに伝え、クラッシュさせない。  
- **UNIQUE制約**: `logs` に `UNIQUE(habitId, date)` を設定し、1習慣1日1レコードを保証。  
- **外部キーと削除**: `FOREIGN KEY(habitId) ON DELETE CASCADE` を設定し、`PRAGMA foreign_keys = ON` をDBオープン時に有効化する。  

-----

## 6\. シーケンス設計（動きの流れ）

### 6.1 記録フロー（楽観的UI）

1.  **UI**: ユーザーが `HabitButton` をタップ。
2.  **Logic (`useHabitRecord`)**:
      * `SensoryFeedback.triggerImpact()` を即実行（音＋振動）。
      * 画面上のステータスを `done` に変更（アニメーション開始）。
3.  **DB (`logTable`)**:
      * 非同期で `INSERT INTO logs ...` を実行。
4.  **UI**:
      * DB保存完了通知を受け取り、ヒートマップを更新。
      * 万が一エラーなら、トーストを出してボタンを元に戻す。

### 6.2 ウィジェット連携フロー

1.  **OS**: ウィジェットから `dotchain://record/habit_123` というURLでアプリを開く。
2.  **App (`_layout.tsx`)**:
      * `Linking.addEventListener` でURLをキャッチ。
      * URLから `habit_id` を取り出す。
3.  **Logic**:
      * `useHabitRecord` の記録関数を自動実行。
      * ユーザーには「アプリが開いた瞬間、勝手にボタンが押された」ように見える。

### 6.3 日付変更監視フロー

1.  **App (`_layout.tsx`)**:
      * `AppState` を監視。アプリが手前に戻ってきた（Active）ことを検知。
2.  **Logic**:
      * `new Date()` で現在時刻を取得。
      * 前回の日付と比較し、変わっていれば `queryClient.invalidateQueries()` を実行。
3.  **UI**:
      * データが再取得され、昨日のボタン状態がリセットされる。

-----

## 7\. エラーハンドリング・セキュリティ

  - **DBエラー**: トースト (`Toast.show`) でユーザーに通知し、アプリをクラッシュさせない。
  - **課金エラー**: ネットワークエラーの場合は「オフラインです」と表示。
  - **データ保護**: 個人情報は扱わない。ログ (`console.log`) にユーザーの入力内容（習慣名）を出力しない。

-----

## 8\. 開発順序（推奨）

この設計書に基づき、以下の順序で実装することを推奨します。

1.  **Core**: `src/core/sensory` を作り、空のボタンを押して「気持ちいいか」を確認する。（プロトタイプ）
2.  **DB**: `src/db` を作り、テーブルを作成する。
3.  **Feature**: `src/features/habit` を作り、DBへの保存処理を書く。
4.  **UI**: Tamaguiで見た目を整える。
5.  **Settings**: 多言語対応と設定画面を作る。
6.  **Pro**: 課金機能を組み込む。

-----



### 🎓 小中学生向け：用語とコマンドの解説

この設計書に出てくる、少し難しい言葉やコマンドを解説します。

1.  **UUID (ユーユーアイディー)**
    * **これ何？**: 「世界で絶対に被らないID番号」のこと。
    * **役割**: データを保存する時、「1番、2番…」だとデータが混ざることがあるので、ランダムな長い文字（例: `550e8400-e29b...`）を使って区別します。

2.  **ISO8601 (アイエスオー・ハチロクマルイチ)**
    * **これ何？**: 世界共通の「日時の書き方」ルール。
    * **例**: `2025-01-01T09:00:00Z` みたいな書き方。これを使うと、日本でもアメリカでも時間のズレなく計算できます。

3.  **URL Scheme (ユーアールエル・スキーム)**
    * **これ何？**: アプリ専用の「住所」。
    * **例**: `dotchain://` 。Webサイトが `https://` で始まるのと同じで、これをスマホに入力するとDotChainアプリが起動します。

4.  **Provider (プロバイダー)**
    * **これ何？**: アプリ全体に「データ配るよ〜」って放送する基地局。
    * **役割**: 設定（ダークモードなど）やDBの接続情報を、全画面に行き渡らせるために使います。
