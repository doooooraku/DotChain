

# ディレクトリ構成.md（DotChainを根拠にした汎用テンプレ）

このファイルは、**「どのアプリでも崩れにくい標準構成」**を、DotChain の実物（DotChain-main.zip）で検証して確定したものです。
狙いは次の3つです。

1. **迷子にならない**（置き場所が一意）
2. **増えても崩れない**（画面が増えても整理が維持される）
3. **他人が見ても追える**（責務が明確で“どこを見ればよいか”が決まる）

---

## 0. このテンプレの「絶対ルール」（曖昧さゼロの線引き）

### 0.1 採用する方針（YES）

* ✅ **Expo + Expo Router（ファイルベースルーティング）**
* ✅ **CNG（Continuous Native Generation）** を採用する

  * `android/` と `ios/` は **生成物（generated）** として扱う
  * EAS Build は、`android/ios` が無い場合に Prebuild して生成する ([Expo Documentation][1])
* ✅ `constants/` と `hooks/` は **root直下に置かず `src/` 配下へ寄せる**
* ✅ app config は **`app.config.ts` を唯一の正（Source of Truth）** にする

  * `app.json` は **削除（または使用停止）**
  * app config の正式仕様は Expo の公式リファレンスに従う ([Expo Documentation][2])
* ✅ `.tamagui/` は **生成物なのでコミットしない**（必ず `.gitignore`） ([Tamagui][3])
* ✅ “画面（ルート）” は `app/`、それ以外（ロジック本体）は `src/` に置く

  * Expo Router は `app/` 内のファイルが画面になる・`_layout.tsx` が配下レイアウトを定義する ([Expo Documentation][4])

### 0.2 不採用（NO：やらない）

* ❌ `android/` / `ios/` を Git にコミットする（CNGと矛盾するため不採用）

  * `android/ios` があると EAS Build は Prebuild を実行しない ([Expo Documentation][1])
* ❌ `app.json` と `app.config.ts` を併用して二重管理する（ズレるので不採用）
* ❌ `.tamagui/` をコミットする（公式が `.gitignore` 推奨なので不採用） ([Tamagui][3])

---

## 1. 用語（初心者でも迷子にならない）

* **repo（リポジトリ）**：GitHubに置く“プロジェクト一式”の箱
* **root（ルート）**：repoの一番上（`package.json` がある場所）
* **generated（生成物）**：自動で作られるもの。Gitに入れない（例：`node_modules/`, `.expo/`, `.tamagui/`, `android/`, `ios/`）
* **routing（ルーティング）**：画面の切り替えの仕組み。Expo Routerは **ファイル配置＝画面構成** ([Expo Documentation][5])
* **state（状態）**：画面が覚えるデータ（例：設定、習慣一覧、課金状態）
* **service（サービス層）**：外部SDK/APIに触る窓口（例：RevenueCat, Supabase）

---

## 2. 全体構成（完成形：このツリーが正）

### 2.1 ワークスペース（App Factory）構成（あなたの運用に合わせて確定）

あなたは `~/04_app-factory/apps/DotChain` の形で運用しています。
この「工場 → アプリ」構造は強いので **この形を標準**にします。

```
/home/<user>/04_app-factory/
├─ apps/
│  ├─ DotChain/              # 1アプリ=1フォルダ（ここがGit repo）
│  ├─ AppB/
│  └─ AppC/
└─ (任意) tools/             # 工場共通ツール（複数アプリで使う場合のみ）
```

* ルール：**アプリ固有のものは apps/<AppName>/ の中に閉じ込める**
* 工場全体で共通化するものが発生したら、その時点で `tools/` を作る（今は不要なら作らない）

---

### 2.2 repo（DotChain）内のディレクトリ完成形（確定）

```
(repo root)
├─ app/                       # 画面(ルート)：Expo Router の世界
│  ├─ _layout.tsx
│  ├─ index.tsx
│  ├─ settings/...
│  ├─ pro/...
│  └─ habit/...
│
├─ src/                       # ロジック本体（画面以外を全部ここへ）
│  ├─ core/                   # 基盤（i18n, 通知, 触覚/音 など）
│  ├─ features/               # 機能ごと（habit, tutorial など）
│  ├─ stores/                 # 状態管理（Zustand）
│  ├─ db/                     # DB（SQLite）
│  ├─ services/               # 外部サービス窓口（RevenueCat, Supabase等）
│  ├─ ui/                     # 共通UI（Toast等）
│  ├─ types/                  # 型定義
│  ├─ hooks/                  # ← root直下から移設（確定）
│  └─ constants/              # ← root直下から移設（確定）
│
├─ assets/                    # 静的ファイル（画像/フォント/音）
├─ docs/                      # 人間向け資料（設計/運用/作業ログ）
├─ __tests__/                 # Jest テスト
├─ maestro/                   # Maestro E2E（YAML）
├─ .github/workflows/         # CI/CD（GitHub Actions）
├─ scripts/                   # 開発補助スクリプト（必要なものだけ）
│
├─ app.config.ts              # ✅唯一の正：Expo app config :contentReference[oaicite:7]{index=7}
├─ eas.json                   # EAS Build/Submit 設定
├─ package.json               # 依存関係/スクリプト
├─ pnpm-lock.yaml             # pnpm ロック
├─ tsconfig.json              # TypeScript設定
├─ babel.config.js            # Babel設定（Tamagui等）
├─ metro.config.js            # Metro設定
├─ eslint.config.js           # ESLint設定
└─ README.md
```

---

## 3. DotChain-main の「現状（事実）」と「確定移行」

### 3.1 DotChain-main に実在した構成（事実）

DotChain-main.zip には以下が入っていました（抜粋）。

* `app/`：`_layout.tsx`, `index.tsx`, `habit/edit.tsx`, `settings/index.tsx`, `pro/index.tsx`
* `src/`：`core/`, `db/`, `features/`, `services/`, `stores/`, `types/`, `ui/`
* root直下に `constants/` と `hooks/` がある
* `.tamagui/` がある（生成物）
* `android/` がある（ただし `ios/` は **zip内に無い**）
* `maestro/`, `__tests__/`, `.github/workflows/`, `docs/`, `assets/`, `scripts/` がある

### 3.2 このテンプレで「今すぐ確定する移行」

* `constants/` → `src/constants/` に移設（必須）
* `hooks/` → `src/hooks/` に移設（必須）
* `.tamagui/` → `.gitignore` に入れてコミットしない（必須） ([Tamagui][3])
* `android/`（および将来 `ios/`）→ **repoから除外（CNG前提）** ([Expo Documentation][1])
* `app.json` → 廃止（削除）し、`app.config.ts` に統一 ([Expo Documentation][2])

---

## 4. ディレクトリ別：役割・入れてよい物／ダメな物（例つき）

ここが最重要です。**「どこに何を置くか」**が一意になります。

---

### 4.1 `app/`（画面・ルーティングの入口：Expo Router）

**役割**

* `app/` 内のファイルが画面（ルート）になる ([Expo Documentation][5])
* `_layout.tsx` は「配下の画面をどう並べるか（Stack/Tab等）」を定義する ([Expo Documentation][4])

**入れてよい（OK）**

* 画面コンポーネント（例：`app/settings/index.tsx`）
* 画面遷移の定義（Stack/Tabの設定）

**入れてはいけない（NG）**

* DBのSQLやテーブル定義（→ `src/db/`）
* Zustandのstore定義（→ `src/stores/`）
* RevenueCat/SupabaseなどSDK初期化（→ `src/services/`）
* 画面横断の共通UI（→ `src/ui/`）

**DotChain例**

* `app/_layout.tsx`：ルートレイアウト（Provider/Theme/ナビ構造）
* `app/habit/edit.tsx`：習慣編集画面の入口

**他にできること（ただし採用は“必要なら”のみ）**

* ルートグループ：`app/(tabs)/...` のように括ってURLに出さず整理できる（画面が増えたら採用） ([Expo Documentation][5])

  * 今のDotChain規模なら **必須ではない**（採用しないでOK）

---

### 4.2 `src/`（ロジック本体：画面以外のすべて）

`src/` は「アプリの中身」です。画面が増えてもここが整理されていると崩れません。

---

#### 4.2.1 `src/core/`（基盤：全機能共通の土台）

**役割**

* i18n、通知、触覚/音、時間/日付処理など「全体で共通利用するもの」

**入れる**

* 翻訳の辞書ロード、言語切替
* Notificationの登録・スケジュール
* Hapticsやサウンド再生の薄いラッパー

**DotChain例**

* `core/i18n/`
* `core/notification/`
* `core/sensory/`

---

#### 4.2.2 `src/features/`（機能単位：ユーザー価値でまとめる）

**役割**

* “機能”ごとに一塊にする（習慣、チュートリアル、課金など）

**入れる**

* 機能固有のUI部品、ロジック、ユースケース
* 機能固有のDB操作（ただしDBの接続基盤は `src/db/`）

**DotChain例**

* `features/habit/`
* `features/tutorial/`

**他にできること（採用条件付き）**

* 機能が巨大化したら `features/habit/components/`, `features/habit/hooks/` のように機能内で再分割

  * ただし、今の規模で不要ならやらない（分割しすぎると逆に迷子になる）

---

#### 4.2.3 `src/stores/`（状態管理：Zustandの中心）

**役割**

* 「状態＝アプリの記憶」をここに集約する
* 画面が増えても、状態の“出どころ”が一目でわかる

**入れる**

* Zustand store（habit/settings/pro/uiなど）

**入れない**

* SDKやDBの実処理（storeは“呼ぶだけ”に寄せる）

---

#### 4.2.4 `src/db/`（DB：SQLite）

**役割**

* DB接続、テーブル定義、クエリ実行の共通をまとめる

**必須ルール（曖昧さゼロ）**

* 外部キー制約（CASCADE等）を使うなら、SQLiteは `PRAGMA foreign_keys = ON` を有効にする（SQLiteの基本仕様）

  * Expo SQLite自体はDBを提供するだけなので、初期化でPRAGMAを叩くのが安全です ([Expo Documentation][6])

**入れる**

* `database.ts`（接続と初期化）
* `schema.ts`（テーブル作成SQL）

---

#### 4.2.5 `src/services/`（外部サービス窓口）

**役割**

* 外部SDK（RevenueCat）や外部API（Supabase）へ触る窓口を作る
* 画面がSDKを直接触り始めると、将来差し替えが地獄になるので、必ず一枚ラッパーを挟む

**入れる**

* `proService.ts`（課金状態取得・同期など）
* `supabaseClient.ts`（クライアント初期化）

---

#### 4.2.6 `src/ui/`（共通UI部品）

**役割**

* 画面横断で使うUI（Toast、DialogHost、共通Buttonなど）

**DotChain例**

* Toast系

---

#### 4.2.7 `src/types/`（型）

**役割**

* 型定義（データモデル、DTO、ユーティリティ型）

---

#### 4.2.8 `src/hooks/` / `src/constants/`（今回“確定で採用”）

**役割**

* 画面でも機能でも使う “共通フック” と “共通定数” を置く

**結論**

* root直下に置かない
* 必ず `src/` 配下に寄せる（このテンプレの絶対ルール）

---

### 4.3 `assets/`（静的ファイル）

**入れる**

* 画像、フォント、音、アプリアイコン素材など

---

### 4.4 `docs/`（人間向け資料：資産）

**入れる**

* 仕様、設計、運用、作業レポート
* 迷った時の意思決定ログ

---

### 4.5 `__tests__/`（Jest）

**役割**

* ユニット/コンポーネントテスト

---

### 4.6 `maestro/`（E2E：Maestro YAML）

**役割**

* 実機/エミュレータで“ユーザー操作”を自動化するE2E
* YAMLで書いて `maestro test` で実行 ([Maestro Documentation][7])
* Expo公式もEAS WorkflowsでMaestroを回す例を提供している ([Expo Documentation][8])

---

### 4.7 `.github/workflows/`（CI/CD）

**役割**

* lint/test/build などを自動化
* 「人間が忘れる作業」を全部ここへ移す

---

### 4.8 `scripts/`（補助スクリプト）

**方針（曖昧さゼロ）**

* “手でやるとミスる作業” だけを置く
* なんでも入れない（増やすほど混乱する）

---

## 5. 生成物（Gitに入れない：必須ルール）

`.gitignore` に必ず入れる（CNG前提）。

```
node_modules/
.expo/
.tamagui/
android/
ios/
dist/
build/
*.log
```

### 理由

* `.tamagui` は生成物（公式がgitignore推奨） ([Tamagui][3])
* `android/ios` はCNGでは生成物。EAS Buildは無い場合に生成し、ある場合は生成しない ([Expo Documentation][1])

---

## 6. app config 統一ルール（app.json廃止）

### 6.1 結論（確定）

* `app.config.ts` を唯一の正にする
* `app.json` は削除する（または使わない）

### 6.2 理由（一次情報）

Expo公式：app config（`app.json` / `app.config.ts`）はPrebuild生成やOTA manifestなどに使われる ([Expo Documentation][2])
→ 二重管理すると「Prebuildに効いた／効いてない」がズレて事故る。

---

## 7. “憶測を消す”確認コマンド集（意味・例つき）

ここは「聞かれたらこれを叩けば確定する」セットです。

---

### 7.1 ツリーを確定する

```bash
pwd
ls -alh
tree -a -L 3
```

**意味**

* `pwd`：今いる場所を表示（迷子防止）
* `ls -alh`：ファイル一覧を詳細表示（権限・更新時刻も）
* `tree -a -L 3`：ディレクトリ構造を木で表示

  * `-a`：隠しファイルも表示
  * `-L 3`：深さ3階層まで

---

## 8. DotChainからこのテンプレへ移す「確定作業」（手順・意味・例）

### 8.1 constants/hooks を src 配下へ移す（必須）

```bash
mkdir -p src/constants src/hooks
git mv constants/* src/constants/
git mv hooks/* src/hooks/
rmdir constants hooks 2>/dev/null || true
```

**意味**

* `mkdir -p`：フォルダが無ければ作る（途中の階層も）
* `git mv`：Gitの履歴を保ったまま移動
* `rmdir`：空になったフォルダを消す（失敗してもOKにしている）

### 8.2 import を一括で確認して直す（必須）

```bash
rg "from ['\"]\.\./constants|from ['\"]\.\./hooks|from ['\"]constants|from ['\"]hooks" -n .
```

**意味**

* 旧パス参照が残っていないか確定する

---

## 9. CNGにするための「確定作業」（android/iosをGitから外す）

### 9.1 Git管理から外す（ローカルに残したまま）

```bash
git rm -r --cached android
git rm -r --cached ios 2>/dev/null || true
```

**意味**

* `--cached`：実ファイルは残すが、Git追跡だけ外す
* CNGでは `android/ios` は生成物なので追跡しない ([Expo Documentation][1])

### 9.2 `.gitignore` に追記（必須）

```
android/
ios/
.tamagui/
.expo/
node_modules/
```

---

## 10. まとめ（このテンプレの“結論”）

* 画面は `app/`、ロジック本体は `src/`
* `constants/` と `hooks/` は `src/` 配下に寄せる（確定）
* app config は `app.config.ts` に統一し、`app.json` は廃止（確定） ([Expo Documentation][2])
* CNG採用のため `android/ios` は生成物としてGit管理しない（確定） ([Expo Documentation][1])
* `.tamagui` は生成物なのでコミットしない（確定） ([Tamagui][3])
* Maestro / Jest / GitHub Actions は “必要十分” なので現状維持でOK（DotChain規模に合っている） ([Maestro Documentation][7])

---

必要なら、次の返答であなたの **DotChain-main.zip の現状ツリー → この完成形ツリー**にするための「差分パッチ（具体的にどのファイルをどう編集するか）」まで、**コマンド＋修正点＋例**で完全に書き切ります。
その場合は、あなたがWSLで `tree -a -L 4` と `npx expo config --type public` の出力を貼ってくれれば、**憶測ゼロで100%確定**できます。

[1]: https://docs.expo.dev/workflow/continuous-native-generation/?utm_source=chatgpt.com "Continuous Native Generation (CNG)"
[2]: https://docs.expo.dev/workflow/configuration/?utm_source=chatgpt.com "Configure with app config"
[3]: https://tamagui.dev/docs/intro/compiler-install?utm_source=chatgpt.com "Tamagui Compiler"
[4]: https://docs.expo.dev/router/basics/layout/?utm_source=chatgpt.com "Navigation layouts in Expo Router"
[5]: https://docs.expo.dev/router/basics/core-concepts/?utm_source=chatgpt.com "Core concepts of file-based routing in Expo Router"
[6]: https://docs.expo.dev/versions/latest/sdk/sqlite/?utm_source=chatgpt.com "SQLite"
[7]: https://docs.maestro.dev/?utm_source=chatgpt.com "Maestro Documentation | Maestro"
[8]: https://docs.expo.dev/eas/workflows/examples/e2e-tests/?utm_source=chatgpt.com "Run E2E tests on EAS Workflows and Maestro"
