# 4_実装ルール（DotChain v1.0）

---

## 1. 本書の目的

本書「4_実装ルール.md」は、DotChain v1.0 を開発・改修するエンジニアが

- 「**どのような書き方・構成ルール** でコードを書くべきか
- 「**どのようなコマンド・手順** で開発・テスト・ビルドを行うか

を迷わずに進められるようにするための **共通ルール集** です。

0〜3 の仕様書が「**何を作るか**」を定義しているのに対し、本書は「**どういう作法で実装するか**」を定義します。

---

## 2. 開発環境ルール

### 2-1. 前提バージョン

- Node.js：v20 系（LTS）
- pnpm：v9 系
- TypeScript：プロジェクトの `devDependencies` に記載されたバージョン
- Expo SDK：プロジェクトの `package.json` に記載されたバージョン

> ※バージョンを上げる場合は、`7_リリース&変更管理.md` に沿って変更理由・影響範囲を整理したうえで実施すること。

### 2-2. 必須グローバルツール

- `node`：JavaScript/TypeScript を動かすランタイム
- `pnpm`：パッケージマネージャ（ライブラリ管理ツール）
- `git`：バージョン管理ツール

インストール後、バージョン確認コマンド例：

```bash
node -v
pnpm -v
git --version
```

### 2-3. 依存ライブラリのインストール

```bash
pnpm install
```

- `pnpm install`：`package.json` に書かれた依存ライブラリを一括インストールするコマンド。
- 初回クローン時・ライブラリ追加後に実行する。

---

## 3. ディレクトリ・ファイル構成ルール

### 3-1. 基本構成

`src/` 配下は以下のような責務で分割する（実際のリポジトリと若干の差がある場合は、**この構成に寄せる方向でリファクタリング** する）。

```text
src/
  app/                  # 画面（Expo Router）
    index.tsx           # S-01 ホーム
    settings.tsx        # S-02 設定
    habit-edit.tsx      # S-03 習慣編集
    pro.tsx             # S-04 Proプラン画面
  components/           # 再利用UIコンポーネント（ロジック薄め）
  stores/               # Zustand ストア
  services/             # ドメインロジック / Repository / 外部サービス連携
  db/                   # DBクライアント / スキーマ
  types/                # 型定義（ドメインモデル）
  utils/                # ログ / 共通ヘルパー
```

### 3-2. ファイル命名規則

- Reactコンポーネントファイル：`PascalCase.tsx`
  - 例: `HabitList.tsx`, `HeatmapCalendar.tsx`
- Hook / util 関数ファイル：`camelCase.ts`
  - 例: `useHabitForm.ts`, `dateService.ts`
- Store ファイル：`xxxStore.ts`
  - 例: `habitStore.ts`, `settingsStore.ts`
- 型定義：`models.ts` などドメイン名を付与

### 3-3. 1ファイル1責務ルール

- 1ファイルには **1つのコンポーネント / Store / Repository** を基本とする。
  - 例外：ごく小さな補助コンポーネントを同じファイル内に定義するのは可。

---

## 4. コーディング規約（TypeScript / React Native）

### 4-1. TypeScript ルール

- `tsconfig.json` は **strict モード** を基本とする（`strict: true`）。
- `any` は原則禁止。やむを得ず使う場合は、コメントで理由を書く：
  - 例：`// FIXME: SDK側型定義の都合で any を使用している。次回アップデートで対応検討`
- 型定義は `src/types/models.ts` に集約し、画面やStoreではそれをインポートして使う。

### 4-2. 命名規則

- コンポーネント：`PascalCase`（例：`HomeScreen`, `HabitListItem`）
- 変数 / 関数：`camelCase`（例：`loadHabits`, `toggleTodayStatus`）
- 定数：`UPPER_SNAKE_CASE`（例：`SETTINGS_KEY`, `PRO_KEY`）
- Store の hook：`useXXXStore`（例：`useHabitStore`）

### 4-3. React コンポーネント

- プレゼンテーション（見た目）とロジックを可能な限り分ける。
  - 画面レベル：`src/app/index.tsx` など、Store 呼び出し + コンポーネント組み立てを担当。
  - コンポーネントレベル：`src/components/HabitListItem.tsx` など、Props を受け取って描画する役割。
- Props の型は必ず `interface` か `type` で明示する。

```ts
interface HabitListItemProps {
  habit: Habit;
  onToggle: () => void;
  onEdit: () => void;
}

export function HabitListItem({ habit, onToggle, onEdit }: HabitListItemProps) {
  // ...
}
```

### 4-4. JSX / スタイル

- スタイルは可能な限り Tamagui やスタイルオブジェクトで管理し、**マジックナンバーをベタ書きしない**。
  - 例：余白は `8 / 12 / 16 / 24` のように決めたステップを使用。
- インラインスタイルが複雑になってきたら、`styled` コンポーネントや `StyleSheet.create` に切り出す。

---

## 5. 状態管理（Zustand）ルール

### 5-1. Store の責務分離

- `habitStore`：習慣マスタの管理
- `logStore`：習慣ログ（今日 / 過去）の管理
- `settingsStore`：設定（言語・テーマ・演出など）
- `proStore`：Pro状態 / RevenueCat連携
- `uiStore`：トースト / グローバルUI状態

**画面コンポーネントからは Store を通してのみドメインデータにアクセスする。**

### 5-2. Selector の使用

- パフォーマンスのため、Store を使うときは selector を使い、必要な値だけを購読する。

```ts
const habits = useHabitStore(state => state.habits);
```

### 5-3. ビジネスロジックの場所

- DB や RevenueCat などの外部連携は **Repository / Service レイヤ** にまとめる。
- Store は「外部サービス呼び出し + 状態更新」のみを行う。

---

## 6. エラーハンドリング / ログ出力ルール

### 6-1. 共通ルール

- すべての「失敗しうる処理（DB、ネットワーク）」は `try/catch` で囲み、
  - ユーザーには **トースト** で簡潔に伝える
  - 開発者向けには `logger.error()` で詳細を残す

### 6-2. logger の使い方

```ts
import { logger } from "@/utils/logger";

logger.info("Load habits started");
logger.error("Failed to load habits", error);
```

- `logger.info`：開発中のデバッグ用途。`__DEV__` の時だけコンソールに出力。
- `logger.error`：本番でもログとして残したいエラー。

### 6-3. エラーとUIの対応

- **課金購入失敗 / 復元失敗**：
  - 必ず Toast を表示（Alertではなく）
  - 文言例：「購入に失敗しました。時間をおいて再度お試しください。」

- **DB 書き込み失敗（習慣記録）**：
  - トグルの状態を元に戻す
  - Toast 表示：「保存に失敗しました」

---

## 7. Free / Pro 判定ルール

### 7-1. 判定ソース

- Free / Pro の判断は **必ず `useProStore().isPro`** を使うこと。
- RevenueCat の `entitlements` を UI から直接参照しない（すべて `proService` / `proStore` 経由）。

### 7-2. 上限チェックの場所

- 「Freeは習慣3件まで」の制御は、
  - 「**新規習慣保存時**」にのみ行う。
  - Hom画面での常時表示（「あと◯件」など）は行わない。

実装イメージ：

```ts
const { isPro } = useProStore();
const { habits, addHabit } = useHabitStore();

async function handleSaveHabit(input: HabitFormInput) {
  if (!isPro && habits.length >= 3) {
    Alert.alert(
      t("habit.limitTitle"),
      t("habit.limitMessage"),
      [
        { text: t("common.cancel"), style: "cancel" },
        { text: t("pro.checkPlan"), onPress: () => router.push("/pro") },
      ],
    );
    return;
  }
  await addHabit(input);
}
```

---

## 8. i18n（多言語）ルール

### 8-1. キー管理

- 画面名 + 用途でキーを構成：
  - 例：`home.title`, `settings.section.language`, `pro.button.monthly` など。
- ハードコード文字列は禁止（テストログ・一時的なdebugは除く）。

### 8-2. 対応言語

- 18言語（アラビア語を除く）を `LanguageCode` として管理。
- JSON ファイル例（`locales/ja.json`）：

```json
{
  "home": {
    "title": "今日のドットチェーン",
    "empty": "最初の習慣を追加しましょう"
  },
  "habit": {
    "limitTitle": "無料版の上限に達しました",
    "limitMessage": "無料版では習慣は3つまでです。Proにアップグレードすると無制限に追加できます。"
  }
}
```

### 8-3. 実装ルール

- 画面コンポーネントでは `useTranslation()` を使用。

```ts
const { t } = useTranslation();
<Text>{t("home.title")}</Text>
```

- Settings で言語を変更したら、SettingsStore を更新し、i18n インスタンスにも反映する：

```ts
i18n.changeLanguage(lang);
await settingsRepository.save(nextSettings);
```

---

## 9. テストルール

### 9-1. テスト観点

- **ユニットテスト必須対象**：
  - `logRepository.upsert` など、習慣記録ロジック
  - Free / Pro の上限判定関数
  - 日付計算（todayKey, range計算）

- **E2Eテストで確認するフロー（Maestroなど）**：
  - アプリ起動 → 習慣追加 → 今日の完了 → カレンダー反映
  - Free状態で4件目の習慣追加 → 上限ダイアログ表示
  - Pro購入成功 → 広告消える / テーマ選択解放
  - 言語切替 → 画面の文言が即時に変わる

### 9-2. コマンドと意味

```bash
pnpm test
```

- 役割：設定されているすべてのテスト（ユニットテスト・コンポーネントテスト）を実行する。

```bash
pnpm maestro test
```

- 役割：Maestro のテストスクリプトに基づき、実機/エミュレータを自動操作してE2Eテストを実行する。

> **E2E（End to End）テスト**：アプリの「起動から終了まで」の一連の流れを実際に操作して確認するテスト。

---

## 10. Git 運用ルール

### 10-1. ブランチ戦略（基本）

- `main`：リリース済み or リリース候補の安定ブランチ
- `develop`：開発ブランチ（存在している場合）
- 機能追加・改修ごとに `feature/xxx-yyy` ブランチを切る：
  - 例：`feature/pro-purchase-flow`, `feature/admob-banner`

### 10-2. コミットメッセージ

**Conventional Commits** 形式を推奨：

- `feat: add pro purchase flow`
- `fix: handle habit log write error`
- `refactor: split habit list into item component`

> 単語メモ
> - **feat**：新機能追加
> - **fix**：バグ修正
> - **refactor**：見た目の動作は変えずにコードを整理

### 10-3. PR（Pull Request）ルール

- 1PR の変更行数は **最大 500行程度** を目安に分割（可能な限り）。
- PR の説明には：
  - 目的（何を解決するか）
  - 主な変更点
  - 動作確認手順

を含める。

---

## 11. ビルド / リリース前チェック

### 11-1. Lint & Format

（プロジェクトに ESLint / Prettier が導入されている前提）

```bash
pnpm lint
pnpm format
```

- `pnpm lint`：コードスタイル・バグの可能性などを自動チェック。
- `pnpm format`：コードの見た目（インデント・クォーテーションなど）を自動整形。

### 11-2. ビルド確認

```bash
pnpm expo run:ios
pnpm expo run:android
```

- 本番ビルドに近い状態でアプリが起動するか、基本フローが動くか確認する。

---

## 12. セキュリティ / 環境変数ルール

### 12-1. 秘密情報の扱い

- RevenueCat の APIキー、AdMob の広告ユニットID などは **ソースコードに直書きしない**。
- `.env` や Expo の `app.config` の仕組みを使い、環境変数として注入する。
- `.env` ファイルは `.gitignore` に必ず追加する。

### 12-2. ProState / Settings の保存

- ProState（課金状態）、Settings（言語・テーマなど）は SecureStore に保存する。
- 平文で外部に送信することがないように注意する。

---

## 13. 参考アプリ・資料

DotChain の実装ルール・構成を検討する際に参考にしたアプリ・資料：

- Loop Habit Tracker（OSS）  
  https://loophabits.org/
- Streaks  
  https://streaksapp.com/
- Habitify  
  https://habitify.me/
- Productive  
  https://productiveapp.io/
- RevenueCat ドキュメント  
  https://www.revenuecat.com/docs
- Google AdMob ドキュメント  
  https://developers.google.com/admob
- i18next 公式  
  https://www.i18next.com/

---

本「4_実装ルール.md」を守ることで、DotChain のコードベースは：

- どのエンジニアが入ってきても迷わずに読み書きできる
- Free/Pro・多言語・広告・課金といった「壊れやすいポイント」が一定のパターンに揃う

状態を目指します。

実装中に「このルールではカバーできていないケース」が現れた場合は、

1. 一時的な個人ルールで対処するのではなく
2. このファイルの該当セクションを追記・修正し
3. 仕様書全体（0〜7）の整合性を確認したうえで

プロジェクトのルールとしてアップデートしてください。