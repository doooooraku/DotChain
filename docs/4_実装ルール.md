
# 4_実装ルール.md（DotChain）

## 1. はじめに

### 1.1 本書の目的

このドキュメントは、アプリ **「DotChain」** のコードを書く際の**「法律（ルールブック）」**です。

- **3_詳細設計書**: 「何を作るか」の設計図。
- **4_実装ルール（これ）**: **「どう書くか」の作法。**

開発者（あなた）は、このルールに従ってコードを書くことで、**「3ヶ月後の自分が見ても理解できる」「バグが入りにくい」**高品質なアプリを作ることができます。

### 1.2 対象範囲

- **言語**: TypeScript
- **フレームワーク**: Expo / React Native
- **UI**: Tamagui

---

## 2. 開発環境と基本コマンド

### 2.1 頻出コマンド辞書（DotChain専用）

開発中、ターミナルで毎日打つコマンドです。

| コマンド | 読み方 | 役割 | いつ使う？ |
| :--- | :--- | :--- | :--- |
| **`pnpm dev`** | ぴーえぬぴーえむ でぶ | アプリを起動する。 | 作業開始時。 |
| **`pnpm lint`** | りんと | コードの文法チェック。 | コミット前。 |
| **`pnpm type-check`** | タイプチェック | 型のエラーチェック。 | 難しいロジックを書いた後。 |
| **`pnpm test`** | テスト | 計算ロジックのテスト。 | 機能完成時。 |
| **`pnpm db:reset`** | ディービーリセット | DBデータを全消去。 | テストデータを消したい時。 |

---

## 3. コーディング規約（Coding Standards）

### 3.1 全般ルール

1.  **TypeScript厳守**: `.js` ファイルは禁止。`any` 型も原則禁止（どうしても必要な場合はコメントで理由を書く）。
2.  **英語命名**: 変数名・関数名は英語。ローマ字（`kinou_tsuika`）は禁止。
3.  **関数コンポーネント**: クラスコンポーネントは禁止。`export function ComponentName() {}` の形式で書く。

### 3.2 React Native & Tamagui 特有ルール

#### 3.2.1 スタイリング (Tamagui)
* **インラインスタイル禁止**: `<View style={{ width: 100 }}>` は避ける。パフォーマンス低下の原因。
* **Tamaguiプロパティ推奨**: `<Stack width={100}>` のように書く。
* **定数使用**: 色やサイズは直接書かず、`tokens.ts` や `theme.ts` の定義を使う。
    * OK: `color="$neonGreen"`
    * NG: `color="#39FF14"`

#### 3.2.2 RTL（多言語）対応ルール
アラビア語対応のため、「左・右」の概念を捨て、「始まり・終わり」で書く。

| 禁止プロパティ | 推奨プロパティ | 理由 |
| :--- | :--- | :--- |
| `marginLeft` | **`marginStart`** | アラビア語では「右」がスタートになるから。 |
| `marginRight` | **`marginEnd`** | 同上。 |
| `left` | **`start`** (配置による) | |
| `right` | **`end`** (配置による) | |

### 3.3 状態管理 (Zustand) のルール

* **ストアの分割**: 巨大な「AppStore」を作らず、機能ごとに分ける。
    * `useHabitStore`: 習慣データ用
    * `useSettingsStore`: 設定用
    * `useUIStore`: モーダル開閉など一時的なUI状態用
* **永続化**: アプリ再起動後も残したいデータ（設定など）は `persist` ミドルウェアを使う。

---

## 4. DotChain独自の設計パターン

このアプリの「気持ちよさ」を実現するための鉄の掟です。

### 4.1 楽観的UI (Optimistic UI) の実装パターン

ユーザーを待たせないため、以下の順序を厳守します。

```typescript
// 例: ボタンが押された時の処理
const handlePress = async () => {
  // 1. 即座にフィードバック（音・振動）
  Sensory.triggerImpact();

  // 2. UIを「成功状態」に更新（DBを待たない）
  setOptimisticStatus('done');

  try {
    // 3. 裏でDB保存
    await db.insertLog(...);
  } catch (error) {
    // 4. 失敗したら静かにUIを戻し、エラー通知
    setOptimisticStatus('idle');
    Toast.show('Save failed');
  }
};
````

### 4.2 ハプティクス（振動）の使用基準

むやみに振動させると不快になります。以下の定義に従ってください。

| 場面 | 強さ | 関数 |
| :--- | :--- | :--- |
| **記録完了** | **Heavy** (重い) | `Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Heavy)` |
| **設定変更** | **Light** (軽い) | `Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Light)` |
| **エラー/取消** | **Notification** | `Haptics.notificationAsync(Haptics.NotificationFeedbackType.Error)` |

-----

## 5\. Git運用ルール

### 5.1 ブランチ戦略（Simple Flow）

1.  **`main`**: 常にリリース可能な完成品。直接コミット禁止。
2.  **`feature/xxx`**: 新機能開発用（例: `feature/widget-support`）。
3.  **`fix/xxx`**: バグ修正用（例: `fix/rtl-layout-bug`）。

### 5.2 コミットメッセージ

「何をしたか」を接頭辞で明示します。

  * **feat**: 新機能 (`feat: ウィジェット機能を追加`)
  * **fix**: バグ修正 (`fix: アラビア語でのレイアウト崩れ修正`)
  * **docs**: ドキュメント (`docs: 実装ルール更新`)
  * **refactor**: リファクタリング (`refactor: 振動ロジックを整理`)

-----

## 6\. セキュリティと安全性

### 6.1 機密情報の扱い

  * **APIキー**: RevenueCatやAdMobのキーは `.env` ファイルに書き、Gitに上げない。
  * **ログ**: `console.log` にユーザーの入力内容（習慣名など）を出さない。

### 6.2 SQLインジェクション対策

  * SQLiteのクエリには必ずプレースホルダー（`?`）を使う。
      * OK: `db.runAsync('INSERT INTO habits (name) VALUES (?)', [name])`
      * NG: `db.runAsync('INSERT INTO habits (name) VALUES ("' + name + '")')`

-----

## 7\. リリース前の儀式（Checklist）

コードを書き終え、プルリクエスト（PR）を出す前に必ず実行すること。

```bash
# これが一発で通るまで修正を繰り返す
pnpm lint && pnpm type-check && pnpm test
```

-----

## 8\. このルールの更新

開発を進める中で「もっと良い書き方」が見つかったら、このファイルを更新し、チーム（未来の自分）に共有してください。ルールは改善され続けるべきです。

-----


### 🎓 小中学生向け：用語解説

このルールブックに出てくる、プログラミングの「お作法」用語を解説します。

1.  **Lint (リント)**
    * **意味**: コードの「文法チェッカー」。
    * **役割**: 文章の誤字脱字を直すように、プログラムの書き間違いや、行儀の悪い書き方を自動で見つけて注意してくれます。

2.  **Type Check (タイプチェック)**
    * **意味**: 「型（かた）」の確認。
    * **役割**: 「ここは数字が入る箱だよ」と決めた場所に、間違って文字を入れようとしていないかチェックします。これのおかげで、アプリが突然落ちるのを防げます。

3.  **Optimistic UI (楽観的UI)**
    * **意味**: 「きっと成功するよね！」と信じて、結果を先に見せちゃうこと。
    * **役割**: 通信待ちのイライラを消して、アプリをサクサク動いているように見せる魔法のテクニックです。

4.  **RTL (Right to Left)**
    * **意味**: 「右から左」へ読むこと。
    * **役割**: アラビア語などの国の人にも使いやすくするために、画面のレイアウトを鏡のように反転させる仕組みです。`marginLeft`（左の余白）を使わず `marginStart`（始まりの余白）と書くのがコツです。

