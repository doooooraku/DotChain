
# 2_機能設計書.md（DotChain）

## 1. はじめに

### 1.1 本書の目的

このドキュメントは、「DotChain」のボタンを押した時などの**「具体的なアプリの動き（振る舞い）」**を定義した設計図です。

- **0_プロダクト戦略**: コンセプト（快感、ミニマル）
- **1.5_UI_画面設計書**: 画面の見た目
- **2_機能設計書（これ）**: **「操作」と「裏側の処理」の台本**

開発者（あなた）は、これを読めば「プログラムでどんな順序で処理を書けばいいか」が具体的に分かります。

---

## 2. 機能一覧

| 機能ID | 機能名 | 概要 | 機能種別 | 対応画面ID | 備考 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **F-01** | **ワンタップ記録** | ボタンを押して習慣を完了/取消する | 画面系 | S-01 | **最重要機能**。楽観的UI採用。 |
| **F-02** | **習慣管理** | 習慣の追加・編集・削除 | 画面系 | S-03 | Free版は3つまで制限。 |
| **F-03** | **設定変更** | 言語・音・振動・テーマを変える | 画面系 | S-02 | 即時反映。 |
| **F-04** | **Proプラン購入** | 課金して制限を解除する | 課金系 | S-04 | RevenueCat連携。 |
| **F-05** | **広告表示** | 画面下にバナー広告を出す | 広告系 | S-01 | 無料版のみ。 |
| **F-06** | **日付更新チェック** | 日付が変わったか確認する | バックグラウンド | 全画面 | 0時越え対策。 |
| **F-07** | **通知予約** | 指定時間にローカル通知を予約する | 通知系 | S-02 | サーバー不要。 |
| **F-08** | **ウィジェット連携** | ウィジェットから記録を行う | 外部連携 | W-01 | アプリ起動→自動記録。 |
| **F-09** | **アイコン変更** | アプリアイコンを変更する | 設定系 | S-02 | Pro限定。 |

---

## 3. 機能詳細フロー

### F-01: ワンタップ記録 (One-Tap Record)

**コンセプト**: 「保存を待たない」。ユーザーが押した瞬間に快感を与える。

#### 3.1.1 ユーザーシナリオ
ユーザーはホーム画面のボタンをタップする。
**瞬時に**「コンッ」という振動と光が走り、その後にデータが保存される。

#### 3.1.2 正常系フロー（完了にする）
1.  **ユーザー**: `S-01 ホーム` の `HabitButton` をタップ。
2.  **アプリ (UI)**:
    * **待たずに即座に**ボタンを「完了状態（ネオン色）」にする。
    * `Haptics.impactAsync(Heavy)` を実行（振動）。
    * `Sound.play('pop.mp3')` を再生（音）。
    * 紙吹雪（パーティクル）アニメーションを開始。
3.  **アプリ (Logic)**:
    * 非同期で DB (`logs` テーブル) に `INSERT` 文を発行。
    * 日付は `YYYY-MM-DD` 形式で保存。
4.  **アプリ (UI)**:
    * DB保存完了通知を受け取り、上部のヒートマップを更新してドットを埋める。
    * もし連続達成（Streak）記録更新なら、追加のファンファーレ演出を行う。

#### 3.1.3 正常系フロー（取り消す）
1.  **ユーザー**: 完了済みのボタンを **長押し (500ms)** する。
2.  **アプリ (UI)**:
    * 長押し中、白いリングが回転するアニメーションを表示。
    * 完了時、`Haptics.impactAsync(Medium)` を実行。
    * ボタンを「未完了（黒）」に戻す。
3.  **アプリ (Logic)**:
    * DB から該当するログを `DELETE` する。
    * ヒートマップのドットを消す。

#### 3.1.4 異常系フロー（保存失敗）
1.  DBのエラー等で書き込みに失敗した場合。
2.  **アプリ**:
    * ボタンを一瞬「赤色」に光らせる。
    * 不快な振動 (`NotificationError`) を鳴らす。
    * ボタンを「未完了」に戻す。
    * トーストで「保存できませんでした (Error 500)」と表示。

---

### F-02: 習慣管理 (Manage Habits)

**コンセプト**: 無料ユーザーには「課金の壁」を優しく見せる。

#### 3.2.1 正常系フロー（新規追加）
1.  **ユーザー**: 「＋」ボタンをタップ。
2.  **アプリ**: 現在の習慣数をチェック。
    * **Proユーザー**: 無制限 → 手順3へ。
    * **Freeユーザー**:
        * 習慣が2個以下 → 手順3へ。
        * 習慣が3個ある → **`S-04 課金画面` を表示して終了**。
3.  **アプリ**: `S-03 編集モーダル` を表示。
4.  **ユーザー**: アイコンを選び、名前を入力して保存。
5.  **アプリ**: DB (`habits` テーブル) に `INSERT`。ホーム画面を更新。

---

### F-03: 設定変更 (Instant Settings)

**コンセプト**: 再起動させない。その場で世界が変わる。

#### 3.3.1 正常系フロー（言語変更）
> v1 方針: **RTL 言語（アラビア語など）は対応外**。サポート対象は LTR の18言語のみ。初期値は端末のシステム言語を自動採用し、選択は AsyncStorage に永続化する。

1.  **ユーザー**: `S-02 設定` で任意の対応言語を選ぶ（例: 日本語、ドイツ語など）。
2.  **アプリ**:
    * `i18n` の言語設定を変更（対応外コードは `en` にフォールバック）。
    * 設定を AsyncStorage に保存し、次回起動時も保持。
    * **React Context を更新**し、全画面を再レンダリング（レイアウト反転は行わない）。
3.  **結果**:
    * 文字が選択した言語に即時切り替わる。
    * レイアウト方向は LTR のまま維持される。

---

### F-04: Proプラン購入 (Purchase)

**コンセプト**: 失敗させない。

#### 3.4.1 正常系フロー（購入）
1.  **ユーザー**: `S-04 課金画面` で「Yearly Plan」をタップ。
2.  **アプリ**: `RevenueCat` SDK を呼び出し、OSの決済画面を表示。
3.  **ユーザー**: 決済承認（FaceID等）。
4.  **アプリ**:
    * RevenueCat から「購入成功」を受け取る。
    * `SecureStore` に「Pro会員フラグ」を保存（オフライン用）。
    * 画面に「Congratulations!」演出を出す。
    * 広告を即座に消す。

#### 3.4.2 正常系フロー（復元 - Restore）
1.  **ユーザー**: 「Restore Purchase」をタップ（機種変時など）。
2.  **アプリ**: RevenueCat に問い合わせ、過去の購入履歴があればPro権限を復活させる。

#### 3.4.3 異常系フロー（オフライン）
1.  ネットがない状態でボタンを押した。
2.  **アプリ**: OSの決済画面を出さずに、アプリ側で「インターネット接続を確認してください」とトースト表示する。

---

### F-06: 日付更新チェック (Day Change)

**コンセプト**: 「寝落ち」しても大丈夫。

#### 3.6.1 トリガー
* アプリが「バックグラウンド（裏側）」から「フォアグラウンド（手前）」に戻ってきた瞬間。

#### 3.6.2 フロー
1.  **アプリ**: `AppState.addEventListener` で復帰を検知。
2.  **アプリ**: 現在のスマホの日付を取得。
3.  **判定**: 画面に表示している日付と、現在の日付が違うか？
    * **同じ**: 何もしない。
    * **違う**:
        * 画面の日付を「今日」に更新。
        * 習慣ボタンをすべて「未完了」リセット（見た目上）。
        * DBから「今日のログ」を再取得して表示。

---

### F-08: ウィジェット連携 (Widget Deep Link)

**コンセプト**: ホーム画面から1秒で記録。

#### 3.8.1 フロー
1.  **ユーザー**: ホーム画面のウィジェット（今日の習慣）をタップ。
2.  **OS**: DotChainアプリを起動（または手前に表示）。
3.  **アプリ**:
    * 起動パラメータ（URLスキーム `dotchain://record/habit_id_123`）を受け取る。
    * トップ画面が表示されると同時に、**自動的に F-01（記録フロー）を実行**する。
    * ユーザーは「アプリが開いた瞬間、勝手にボタンが押されて完了した」ように見える。

---

## 4. エラーハンドリング共通ルール

### 4.1 ユーザーへの伝え方
* **Toast (トースト)**:
    * 「保存しました」「エラーが発生しました」などの短い通知は、画面下部に小さく出す。
    * 2秒で自動的に消える。操作を邪魔しない。
* **Alert (アラート)**:
    * 「習慣を削除しますか？」などの重要な確認のみ、ポップアップ（OK/Cancel）を使う。

### 4.2 ログ送信（将来用）
* エラー発生時、開発用ビルドでは `console.error` に詳細を出す。
* 本番ビルドでは何も出さない（または将来Sentryに送る）。

---

## 5. チェックリスト

実装時、ここをクリアしているか確認すること。

* [ ] **0.1秒ルール**: ボタンを押した瞬間、DB保存を待たずに音が鳴っているか？
* [ ] **オフライン課金**: 機内モードで課金ボタンを押してもアプリが落ちないか？
* [ ] **日付またぎ**: 夜23:59から0:00を過ぎた時、アプリを開き直すと日付が変わっているか？
* [ ] **RTL**: アラビア語にした時、戻るボタンの向きや配置が逆になっているか？

---


### 🎓 小中学生向け：用語と仕組みの解説

この設計書に出てくる、プログラミングの「カッコいい技」を解説します。

1.  **Optimistic UI (楽観的UI)**

      * **意味**: 「たぶん成功するだろう」と信じて、結果を先に見せちゃうこと。
      * **例**: 「いいね！」ボタンを押した時、サーバーに通信する前にハートを赤くすること。これのおかげで、アプリが「サクサク」動いているように感じます。DotChainの気持ちよさの秘密です。

2.  **Deep Link (ディープリンク)**

      * **意味**: アプリの「特定のページ」や「特定の動き」を直接呼び出す魔法のURL。
      * **例**: ウィジェットを押すと、ただアプリが開くだけじゃなくて、「筋トレボタンを押した状態」まで一気にワープします。

3.  **AppState (アプリステート)**

      * **意味**: アプリが今「使われている（Active）」か、「裏に隠れている（Background）」かを知る見張り役。
      * **役割**: 「おかえり！寝てる間に日付変わったよ！」と教えてくれる係です。

4.  **Restore (リストア/復元)**

      * **意味**: 「機種変しても、私が買った権利を思い出して！」という機能。
      * **役割**: iPhoneを買い替えた時、もう一度お金を払わなくて済むようにするために絶対必要です。
