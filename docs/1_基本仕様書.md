# 1_基本仕様書（DotChain v1.0）

---

## 1. ドキュメントの位置づけ

### 1-1. 目的

この「1_基本仕様書.md」は、DotChain v1.0 の**機能要件**をまとめたドキュメントです。

- 0_プロダクト戦略.md：プロダクトの目的・ターゲット・ビジネスモデル
- **1_基本仕様書.md：実際に「どんな機能が必要か」を一覧・定義する**
- 2_機能設計書.md：ここで定義した機能ごとの詳細な画面フロー・ユースケース
- 3_詳細設計書.md：DB設計・API・コンポーネント単位の設計

という関係になっています。

このファイルだけを読めば、

- DotChain v1.0 で **何ができて、何ができないのか**
- Free版と Pro版で **どこが違うのか**
- 各機能の **優先度 / 画面 / 挙動の概要**

を誰でも把握できる状態を目指します。

### 1-2. 対象バージョン

- アプリバージョン：**DotChain v1.0.0**
- 対応OS：
  - iOS：15 以上（iPhone 8 以降を想定）
  - Android：8.0（API 26）以上

※上記は**サポート対象の目安**であり、詳細な端末検証方針は 5_テスト仕様書.md にて扱います。

---

## 2. システム概要

### 2-1. アプリ概要

- 名称：**DotChain**
- カテゴリ：習慣トラッカー / ライフログ
- プラットフォーム：iOS / Android
- 配布チャネル：App Store / Google Play

### 2-2. 高レベル構成

- クライアントアプリのみ（バックエンドサーバーは v1.0 では持たない）
- データ保存：端末ローカルDB（SQLite 相当）
- ネットワークを使用する機能：
  - RevenueCat 経由の **Pro 課金 / 復元**
  - AdMob バナー広告の表示
- UI レイヤー：React Native + Expo + Tamagui

> ※実際のライブラリ構成・APIキー管理の詳細は 3_詳細設計書 / 4_実装ルール を参照。

---

## 3. 用語定義

初心者でも迷わないように、本仕様書で使う主な単語の意味を最初に定義します。

- **習慣（Habit）**  
  ユーザーが「毎日やりたい」と決めた行動。例：勉強・筋トレ・読書など。

- **記録（Record / Log）**  
  ある1日のある習慣について、「やった」か「やっていない」かを保存したデータ。

- **チェーン（Chain / Streak）**  
  同じ習慣について「連続して記録がある日数」。
  - 例：3日連続で「筋トレ」を実行 → チェーン3日。

- **ヒートマップ（Heatmap）**  
  カレンダー形式で、日ごとの実行状況を色やドットで表示したもの。

- **Free版 / Pro版**  
  - Free：無料ユーザー。利用できる習慣数・テーマ・広告などに制限がある。
  - Pro：有料サブスクリプションユーザー。制限が解除される。

- **サブスクリプション（Subscription）**  
  月額・年額など、定期的に課金される仕組み。

- **バナー広告（Banner Ad）**  
  画面の上下などに細長く表示される広告。全画面広告ではなく、常に一部だけが表示されるタイプ。

- **多言語対応（Localization）**  
  アプリのテキストを複数の言語に訳して、ユーザーが言語を選べるようにすること。

---

## 4. 対象範囲と非対象

### 4-1. v1.0 で提供する主な機能（概要）

- 習慣の追加・編集・削除
- 1日1回の「達成 / 未達成」の記録
- カレンダー / ヒートマップ形式でのチェーン表示
- Free / Pro プランと連動した機能制限
  - Free：習慣 3件まで / 広告あり / テーマ1種（Dark）のみ
  - Pro：習慣数無制限 / 広告なし / 全テーマ（Dark + Neon Pink + Cyber Blue）
- RevenueCat を利用した Proプランの購入 / 復元
- 18言語対応（アラビア語を除く）
- 設定画面からのテーマ切替 / 言語切替 / 効果音・振動・エフェクトの ON/OFF

### 4-2. v1.0 では**やらない**と明確に決めた項目

以下の機能は、旧仕様書では F-08 / F-09 として記載されていましたが、DotChain v1.0 の仕様からは明確に除外します。

- ホームウィジェット / ウィジェット連携
- アプリアイコン変更（Pro 限定アイコンなど）
- RTL（右→左）レイアウト対応
- アプリ内の OSS ライセンス一覧画面

将来のバージョンで再検討する可能性はありますが、
**本書では「存在しない前提」で仕様を記載**します。

---

## 5. 機能一覧（F一覧）

DotChain v1.0 の機能を F-01〜F-07 に整理します。F-08 / F-09 は旧仕様（ウィジェット・アイコン変更）として廃止済みです。

### 5-1. 機能一覧テーブル

| ID   | 機能名                                   | 概要                                                                 | Free版の挙動                                           | Pro版の挙動                                                          | 優先度 | 関連画面             |
|------|------------------------------------------|----------------------------------------------------------------------|--------------------------------------------------------|------------------------------------------------------------------------|--------|----------------------|
| F-01 | 習慣実行の記録（ワンタップ & チェーン） | 毎日の習慣実行をワンタップで記録し、カレンダー上でチェーン表示する。 | 全習慣（最大3件）について同じ挙動。                   | 全習慣（件数無制限）について同じ挙動。                               | MUST   | S-01 ホーム         |
| F-02 | 習慣の追加・編集・削除                   | 習慣を登録し、名前・アイコン・色を編集、削除できる。                 | 登録可能件数は3件まで。4件目は追加できない。         | 登録件数に制限なし。                                                 | MUST   | S-01 ホーム / S-03 編集 |
| F-03 | 設定画面（表示・演出のカスタマイズ）     | 言語・音・振動・テーマ・ヒートマップ範囲・エフェクトを設定。         | テーマは Dark のみ選択可。他のテーマはロック表示。   | Dark / Neon Pink / Cyber Blue の全テーマを選択可。                 | MUST   | S-02 設定           |
| F-04 | Proプラン購入 / 課金復元                 | RevenueCat を利用して Pro プランを購入 / 復元する。                  | Pro購入画面の閲覧は可能。購入・復元はいつでも実施可。| 購入済みの場合、アプリ起動時に Pro 状態として認識される。           | MUST   | S-04 Pro / S-02 設定 |
| F-05 | 多言語切替（18言語対応）                 | アプリ全体の表示言語を 18 言語から選択できる。                      | Free / Pro 共通で 18 言語から選択可能。              | 同上。                                                                | MUST   | S-02 設定 / 全画面  |
| F-06 | Proプラン効果（制限解除）                | Pro 状態に応じて、習慣数・広告・テーマ制限を切り替える。             | 習慣3件まで / 広告あり / テーマ1種のみ。             | 習慣無制限 / 広告なし / 全テーマ解放。                               | MUST   | S-01 / S-02 / S-04  |
| F-07 | バナー広告表示（AdMob）                  | ホーム画面下部にバナー広告を表示する。                               | ホームに常にバナー表示。                             | バナー広告は一切表示しない。                                         | MUST   | S-01 ホーム         |
| F-08 | レビュー依頼（7日連続達成時）            | 習慣の連続達成が7日目になったタイミングでアプリ内レビューを1度だけ促す。 | 連続達成7日で Alert → In-App Review を呼び出す。    | 同上（Pro/Free 共通。端末1回のみ）。                                | SHOULD | S-01 ホーム         |

> S-01〜S-04 は 1.5_UI_画面設計書.md で定義する画面IDです。

---

## 6. 各機能の基本仕様

### 6-1. F-01：習慣実行の記録（ワンタップ & チェーン）

#### 機能概要

- ホーム画面に表示された各習慣について、ユーザーは「今日やったかどうか」を**1タップ**で切り替えられる。
- 記録は「日単位」で管理し、同じ日に何度タップしても、最終的には **達成 / 未達成の2値** で保持する。
- カレンダー上では、達成日をドットや発光するマスとして表示し、連続達成日は「チェーン」として視覚化する。

#### 正常系フロー

1. ユーザーがアプリを起動し、ホーム画面（S-01）を表示する。
2. 本日の日付行に、その日の習慣ボタンが表示される。
3. ユーザーが習慣ボタンをタップする。
4. システムは以下を行う：
   - 当該習慣・当該日付の「記録」を生成 or 更新（達成状態にする）。
   - ボタンの見た目を変更（色・アニメーションなど）。
   - カレンダー上の該当日を「達成」として更新。
   - チェーンの連続日数を再計算し、表示を更新。
5. もう一度タップすると「未達成」に戻せる（トグル）。

#### 例外系（主なもの）

- ローカルDB書き込みエラー
  - ユーザーがタップしても保存に失敗した場合は、トーストで「保存に失敗しました」と表示し、ボタン表示も元に戻す。
- 日付が跨った場合
  - バックグラウンド→フォアグラウンド復帰時に日付が変わっていた場合は、まず日付更新処理（F-08相当の処理。詳細は 2_機能設計書側で扱う）を行ってから表示を更新する。

#### Free / Pro 差分

- 記録数・挙動は Free / Pro で差分なし。
- 差分は「何件の習慣を管理できるか」にのみ影響（F-02 / F-06 を参照）。

---

### 6-2. F-02：習慣の追加・編集・削除

#### 機能概要

- ユーザーは自分の習慣をアプリ内で管理できる。
- 1つの習慣は少なくとも以下の情報を持つ：
  - 習慣名（必須）
  - アイコン（必須・プリセットから選択）
  - カラー（必須・プリセットから選択）

#### Free / Pro の件数制限

- Free版：
  - 登録可能な習慣は **最大3件まで**。
  - 4件目の習慣を新規追加しようとした場合：
    - 実際の保存処理は行わず、Proプランへのアップグレードを促すダイアログを表示する。
    - 例：
      - タイトル：「無料版の上限に達しました」
      - 本文：「無料版では習慣は3つまでです。Proにアップグレードすると無制限に追加できます。」
      - ボタン：
        - 「キャンセル」
        - 「Proを確認する」（S-04 Pro画面へ遷移）

- Pro版：
  - 習慣の登録上限は設けない（理論上無制限）。
  - 実際には端末性能に依存するが、基本設計上の制限は設けない。

#### 編集・削除

- ユーザーは既存習慣を編集できる：
  - 名前・アイコン・カラーを変更可能。
  - 変更は即時保存され、ホーム画面とカレンダーに反映される。
- 削除時の挙動：
  - 関連する過去の記録（ログ）も一括削除する。
  - 削除前に確認ダイアログを表示（「この習慣と記録を削除しますか？」）。

---

### 6-3. F-03：設定画面（表示・演出のカスタマイズ）

#### 機能概要

設定画面（S-02）では、以下の項目をユーザーが変更できる。

1. 言語（F-05）
2. 効果音（サウンド） ON/OFF
3. 振動（ハプティクス） ON/OFF
4. テーマ（Dark / Neon Pink / Cyber Blue）
5. ヒートマップ表示範囲（日数）
6. エフェクト（電流風アニメーション）の ON/OFF
7. 購入を復元（F-04）

補足：
- エフェクト ON/OFF はホーム画面ヒートマップの「チェーンライン上を流れる電流風アニメーション」のみに適用する。
- 習慣ボタンのグローやタップ時のフィードバックは常時有効であり、本設定の対象外とする。

#### テーマ切替の仕様（Free / Pro 差分）

- Free版：
  - Dark テーマのみ
  - Neon Pink / Cyber Blue は表示するが「ロック」アイコンを付与。
  - ロックされたテーマをタップすると、Pro画面（S-04）へ遷移。

- Pro版：
  - 3テーマすべて選択可能。
  - 選択したテーマはアプリ全画面に即時反映。

#### ヒートマップ表示範囲

- 選択肢例：30日 / 60日 / 180日 / 365日
- 選択範囲に応じて、ホーム画面のカレンダー表示範囲を変更。

---

### 6-4. F-04：Proプラン購入 / 課金復元

#### 概要

- RevenueCat を利用して、Proプランを月額または年額で購入できる。
- すでに購入済みの場合、別端末などで「購入を復元」することができる。

#### 購入フロー（正常系）

1. ユーザーがホーム or 設定から Pro画面（S-04）を開く。
2. Pro画面には、
   - 無料版と Pro版の機能比較表
   - 月額プラン / 年額プラン
   が表示されている。
3. ユーザーがいずれかのプランをタップする。
4. RevenueCat SDK を通じて、ストア（App Store / Google Play）の課金画面が表示される。
5. ユーザーが購入を承認し、決済が成功する。
6. アプリは以下を行う：
   - Pro権限の付与（アプリ内フラグ isPro = true）。
   - SecureStore に Pro 状態・匿名ユーザーID を保存。
   - Free制限が解除され、広告が消える、テーマロックが解放される。
   - 購入成功を Alert で通知する（例：「Proプランが有効になりました。」）。

#### 購入失敗時の挙動

- ネットワークエラー / ユーザーキャンセルなどで購入に失敗した場合：
  - エラー内容に応じてメッセージを取得し、**Toast** で表示する。
  - 例：「購入に失敗しました。時間をおいて再度お試しください。」

#### 購入を復元（Restore）

- 設定画面（S-02）に「購入を復元」ボタンを配置。
- 押下時の挙動：
  1. RevenueCat を通じて、過去に有効な購入があるかを問い合わせる。
  2. 有効な購読が見つかった場合：
     - Pro権限を付与し、SecureStore を更新。
     - 「購入履歴を復元しました。」と Alert 表示。
  3. 見つからなかった場合：
     - 「復元可能な購入は見つかりませんでした。」を Toast で表示。
  4. ネットワークエラーなど異常時：
     - 「購入の復元に失敗しました。」を Toast で表示。

---

### 6-5. F-05：多言語切替（18言語対応）

#### 対応言語

DotChain v1.0 では、以下の **18言語** に対応する（アラビア語は除外）。

- en：英語
- ja：日本語
- fr：フランス語
- es：スペイン語
- de：ドイツ語
- it：イタリア語
- pt：ポルトガル語
- ru：ロシア語
- zhHans：中国語（簡体字）
- zhHant：中国語（繁体字）
- ko：韓国語
- th：タイ語
- id：インドネシア語
- vi：ベトナム語
- hi：ヒンディー語
- tr：トルコ語
- pl：ポーランド語
- sv：スウェーデン語

#### 仕様

- 設定画面の「Language」セクションに、上記18言語をボタンまたはリストとして表示。
- 言語選択時：
  - 選択直後にアプリ全体の文言を更新（ホットスワップ）。
  - 再起動を要求しない。
- レイアウト：
  - v1.0 では **LTR（左→右）レイアウトのみ対応**。
  - RTL（右→左）の言語（アラビア語など）はサポート外。

---

### 6-6. F-06：Proプラン効果（制限解除）

#### 概要

Pro状態（isPro = true）のときに、アプリ全体で以下の制限を解除する。

1. 習慣数制限
2. バナー広告表示
3. テーマロック

#### Free / Pro の具体的な違い

| 項目           | Free版                            | Pro版                           |
|----------------|-----------------------------------|----------------------------------|
| 登録できる習慣 | 3件まで                           | 制限なし                        |
| バナー広告     | ホーム画面下部に常時表示         | 一切表示しない                  |
| テーマ         | Dark のみ（他はロック）          | Dark / Neon Pink / Cyber Blue   |

- Pro状態の判定は、起動時に「SecureStore + RevenueCat」から行い、アプリ内の `useProStore` で一元管理する。

---

### 6-7. F-07：バナー広告表示（AdMob）

#### 概要

- Freeユーザーに対してのみ、ホーム画面（S-01）の下部にバナー広告を表示する。
- Proユーザーには広告を一切表示しない。

#### 仕様

- 利用サービス：Google AdMob（`react-native-google-mobile-ads`）
- 広告サイズ：Banner（標準横長バナー）
- 表示位置：ホーム画面下部コンテンツ領域の直下。
- 更新頻度・クリック時の挙動は AdMob SDK に準拠。

#### エラー / 未取得時

- ネットワーク状態などにより広告取得に失敗した場合：
  - アプリ側ではエラーをユーザーに表示しない（静かに何も出さない）
  - レイアウト崩れを防ぐため、必要に応じて固定高さのプレースホルダ領域を用意しておく。

---

## 7. 参考ユースケース一覧

ここでは代表的なユースケースを高レベルで定義します。詳細な画面遷移は 2_機能設計書 で扱います。

### UC-01：毎日の習慣を記録する

1. アプリを起動する（ホーム画面 S-01）。
2. 今日実行した習慣のボタンをタップする。
3. ボタンがアニメーションし、カレンダー上の該当日が「達成」状態になる。
4. 必要なら他の習慣も同様にタップして記録する。
5. アプリを閉じる。

### UC-02：新しい習慣を追加する

1. ホーム画面 S-01 の「＋」ボタンを押す。
2. 習慣編集画面 S-03 が表示される。
3. 習慣名・アイコン・カラーを設定する。
4. 「保存」を押す。
5. Free版で既に3件登録済みの場合：
   - 4件目の保存時に Pro誘導ダイアログが表示され、保存は行われない。

### UC-03：Proプランを購入する

1. 設定画面 S-02 またはホーム画面から Pro画面 S-04 を開く。
2. Free / Pro の比較表を確認する。
3. 「月額」または「年額」のボタンを押す。
4. ストア決済画面で購入を完了する。
5. アプリ内で Pro状態となり、習慣数制限・広告・テーマロックが即座に反映される。

### UC-04：言語を切り替える

1. 設定画面 S-02 を開く。
2. Language セクションから希望の言語を選択する。
3. 直後にアプリ全体の文言が切り替わる。

### UC-05：テーマを変更する（Pro）

1. 設定画面 S-02 を開く。
2. Theme セクションで Neon Pink または Cyber Blue を選択する。
3. アプリ全体の色テーマが即時に変更される。

---

## 8. 非機能要件（概要）

### 8-1. パフォーマンス

- ホーム画面の初回描画：**2秒以内**
- アプリ起動（スプラッシュ→ホーム表示）：
  - コールドスタート：3秒以内
  - ウォームスタート：1.5秒以内

### 8-2. 安定性

- 月次クラッシュ率：**1%未満**
- 課金まわりの障害：発見から72時間以内の修正リリースを目標とする。

### 8-3. セキュリティ

- Pro状態および RevenueCat の匿名ユーザーID は SecureStore などOSレベルで保護されたストレージに保存する。
- APIキーはコードに直書きせず、ビルド時に注入する。

詳細は 6_セキュリティ・法務・ライセンス.md を参照。

---

## 9. 開発でよく使うコマンドと意味（概要）

仕様書の対象読者に「開発初心者」も含まれるため、
ここでは DotChain 開発で頻出するコマンドの意味を簡単に整理しておきます。

> ※実際のフル手順・バージョンロックは 4_実装ルール.md / 開発手順書で詳細化します。

### 9-1. 依存パッケージのインストール

```bash
pnpm install
```

- **pnpm**：Node.js のパッケージ管理ツール。ライブラリをインストールするときに使うコマンド。
- `pnpm install`：`package.json` に書かれたライブラリ（React, React Native, Expo, Tamagui など）を一括でダウンロードして `node_modules` に配置する。

### 9-2. 開発サーバの起動

```bash
pnpm expo start
```

- **expo**：React Native アプリを簡単にビルド・実行するためのツール。
- `expo start`：開発用サーバを起動し、スマホ（Expo Go アプリ）やエミュレータからアプリを実行できるようにするコマンド。

### 9-3. 実機 / エミュレータでの動作確認

```bash
pnpm expo run:ios
pnpm expo run:android
```

- `expo run:ios`：iOS シミュレータや接続された iPhone でアプリをビルド・起動する。
- `expo run:android`：Android エミュレータや接続された Android 端末でビルド・起動する。

### 9-4. テストの実行

```bash
pnpm test
```

- ユニットテストやコンポーネントテストを実行するコマンド。
- アプリの重要なロジックが壊れていないか自動チェックするために定期的に実行する。

### 9-5. E2E テスト（例：Maestro）

```bash
pnpm maestro test
```

- **Maestro**：モバイルアプリの画面操作を自動化してテストするツール。
- `maestro test`：あらかじめ書いておいた操作シナリオ（例：アプリ起動 → 習慣をタップ → チェーン確認）を自動で再生し、期待どおり動くか確認する。

---

## 10. 参考アプリ・参考資料

DotChain の設計にあたって参考にしたアプリや資料を記載します。

- **Loop Habit Tracker**（Android, オープンソース）  
  https://loophabits.org/  
  https://play.google.com/store/apps/details?id=org.isoron.uhabits

- **Streaks**（iOS, Apple Design Award）  
  https://streaksapp.com/  
  https://apps.apple.com/app/streaks/id963034692

- **Habitify**  
  https://habitify.me/

- **Productive**  
  https://productiveapp.io/

これらはあくまで**参考**であり、DotChain は「チェーンの気持ちよさ」と「Freeでも本気で使える設計」に特化して差別化します。

---

この 1_基本仕様書.md をもとに、2_機能設計書・3_詳細設計書で、
画面ごとの挙動やDB構造・API仕様をさらに具体化していきます。

---

### 6-8. F-08：レビュー依頼（7日連続達成）

- 目的：7日連続達成という節目で In-App Review を1回だけ促し、継続ユーザーからの評価を集める。
- トリガー条件：連続達成日数がちょうど7日、かつ端末の `hasRequestedReview` が false。
- 挙動：ホームで達成操作後に約0.8秒遅延で Alert を表示し、OK タップ時に `expo-store-review` を呼び出す。成功/失敗に関わらず `hasRequestedReview` を true に更新し、同一端末では再度依頼しない。
- Free / Pro 差分：なし（共通で動作）。
